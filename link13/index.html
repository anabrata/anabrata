<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Candle Timer – v1.9</title>
<style>
  :root{
    --digit-w: 120px;
    --digit-h: 170px;
    --digit-radius: 16px;
    --split-line: rgba(255,255,255,0.10);

    /* Background (gradient default; image overrides via JS) */
    --bg-angle: 135deg;
    --bg-c1: #3a1c71;
    --bg-c2: #d76d77;
    --bg-c3: #ffaf7b;

    /* Flip clock colors */
    --clock-c1: #0e0f13;
    --clock-c2: #242631;
    --clock-c3: #3b3e4b;
    --clock-text: #ffffff;
    --colon-color: #ffffff;

    /* Buttons */
    --btn-font: "Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    --btn-grad: linear-gradient(135deg,#ffd166,#ff9a00);
    --btn-grad-hover: linear-gradient(135deg,#ffe08a,#ffb347);

    /* Candle */
    --wax: #efe0c2;
    --wick: #1b1b1b;

    --side-gap: min(6vw,56px);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; display:flex; flex-direction:column; color:#f5f5f5;
    font-family:"Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(var(--bg-angle), var(--bg-c1), var(--bg-c2), var(--bg-c3));
    background-attachment: fixed; overflow-x:hidden;
  }

  .brand{ position:fixed; right:12px; top:10px; z-index:40; font-weight:700; font-size:13px; opacity:.9; text-shadow:0 1px 2px rgba(0,0,0,.35); user-select:none; }

  #exitFs{ position:fixed; right:8px; top:6px; z-index:70; width:24px; height:24px; line-height:24px; text-align:center; font-weight:900; color:#fff; background:rgba(0,0,0,.25); border-radius:50%; cursor:pointer; opacity:.35; display:none; }
  #exitFs:hover{ opacity:.65 }

  .main{ flex:1; display:flex; align-items:center; justify-content:space-between; gap:var(--side-gap); padding:22px min(5vw,48px); }

  /* Clock */
  #timer-container{ flex:1; display:flex; align-items:center; justify-content:flex-start; min-width:340px; }
  #timer{ display:flex; align-items:center; gap:12px; user-select:none; }

  .digit{
    position:relative; width:var(--digit-w); height:var(--digit-h); perspective:1200px;
    border-radius:var(--digit-radius); overflow:hidden;
    background: linear-gradient(145deg,var(--clock-c1),var(--clock-c2),var(--clock-c3));
    box-shadow: inset 0 -1px 0 rgba(255,255,255,.06), inset 0 1px 0 rgba(0,0,0,.45);
  }
  .digit .top,.digit .bottom{ position:absolute; left:0; right:0; height:50%; overflow:hidden; backface-visibility:hidden; -webkit-backface-visibility:hidden; }
  .digit .top{ top:0; border-bottom:1px solid var(--split-line); }
  .digit .bottom{ bottom:0; border-top:1px solid var(--split-line); }

  .value{
    position:absolute; left:0; right:0; height:var(--digit-h);
    display:flex; align-items:center; justify-content:center;
    font-weight:800; color:var(--clock-text); text-shadow:0 2px 6px rgba(0,0,0,.6);
    font-size: calc(var(--digit-h)*.70); line-height:var(--digit-h);
  }
  .top .value,.top-flip .value{ clip-path: inset(0 0 50% 0); transform: translateY(0); }
  .bottom .value,.bottom-flip .value{ clip-path: inset(50% 0 0 0); transform: translateY(-50%); }

  .top-flip,.bottom-flip{ position:absolute; left:0; right:0; height:50%; overflow:hidden; backface-visibility:hidden; -webkit-backface-visibility:hidden; background:inherit; }
  .top-flip{ top:0; transform-origin:bottom; border-bottom:1px solid var(--split-line); animation: topFlip .28s ease-in forwards; }
  .bottom-flip{ bottom:0; transform-origin:top; border-top:1px solid var(--split-line); animation: bottomFlip .28s ease-out forwards; }
  @keyframes topFlip{ 0%{transform:rotateX(0)} 100%{transform:rotateX(-90deg)} }
  @keyframes bottomFlip{ 0%{transform:rotateX(90deg)} 100%{transform:rotateX(0)} }

  .colon{ display:flex; align-items:center; justify-content:center; width:calc(var(--digit-w)*.33); height:var(--digit-h); font-size:calc(var(--digit-h)*.6); font-weight:900; color:var(--colon-color); text-shadow:0 2px 6px rgba(0,0,0,.6); }

  /* Candle area */
  #candle-area{ flex:1; display:flex; align-items:flex-end; justify-content:flex-end; min-width:340px; height:max(360px,40vh); position:relative; }

  /* Clip for wax only; flame sits outside so it’s never clipped */
  .candle-clip{ position:relative; width:170px; height:360px; overflow:hidden; display:flex; align-items:flex-end; justify-content:center; }
  .candle-wrap{ position:absolute; inset:auto 0 0 0; margin:auto; width:170px; height:360px; display:flex; align-items:flex-end; justify-content:center; }

  /* High‑quality 3D top: separate rim + inner pool highlights using conic & radial gradients */
  .wax{
    position:absolute; bottom:0; width:140px; height:100%; z-index:1;
    border-radius:20px;
    background:
      radial-gradient(112px 26px at 70px 6px, rgba(255,255,255,.75), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,0) 24%),
      linear-gradient(180deg,#ffffff40,#00000022 40%,#00000030 100%),
      linear-gradient(180deg,var(--wax), #e6d9bb);
    box-shadow: inset 0 6px 18px rgba(0,0,0,.18), inset 0 -10px 18px rgba(0,0,0,.22);
    transition: height .22s linear;
  }
  /* Raised elliptical top with rim and specular glow (3D look) */
  .waxTop{
    position:absolute; top:-20px; left:50%; transform:translateX(-50%); width:140px; height:40px; pointer-events:none; z-index:2;
    background:
      conic-gradient(from 90deg at 50% 50%, rgba(255,255,255,.35), rgba(255,255,255,.05) 30%, rgba(0,0,0,.10) 55%, rgba(255,255,255,.22) 80%, rgba(255,255,255,.35)) ,
      radial-gradient(60% 50% at 50% 60%, rgba(255,255,255,.65), rgba(255,255,255,.12) 60%, rgba(0,0,0,.12) 100%);
    border-radius:50%/60% 60% 40% 40%;
    mix-blend-mode: screen;
    filter: blur(.2px);
  }
  .wax:after{
    content:""; position:absolute; top:28px; left:22px; width:12px; height:60px; border-radius:10px;
    background: linear-gradient(180deg,#fff6,#0000 60%), var(--wax);
    box-shadow: 42px 8px 0 -3px var(--wax), 42px 8px 0 -3px #fff6, 88px 12px 0 -6px var(--wax), 88px 12px 0 -6px #fff6; opacity:.8;
  }
  .wick{ position:absolute; width:6px; height:28px; background:linear-gradient(180deg,#444,var(--wick)); border-radius:4px; top:-10px; left:50%; transform:translateX(-50%); z-index:3; box-shadow:0 -1px 2px #fff8; }

  /* Flame outside the clip so it never gets cut */
  .flame{
    position:absolute; width:50px; height:104px; z-index:6;
    background:
      radial-gradient(ellipse at 50% 20%, #fff9cc 0%, #ffe08a 35%, #ffac30 55%, #ff7a00 75%, transparent 76%),
      radial-gradient(ellipse at 50% 40%, #ffffff 0%, transparent 60%);
    border-radius:50% 50% 38% 38%; filter: blur(.6px);
    box-shadow:0 0 20px 7px rgba(255,170,40,.6), 0 0 40px 14px rgba(255,140,0,.45), 0 -20px 28px rgba(255,220,170,.42);
    animation:flicker .12s infinite;
    transition:opacity .35s ease;
    will-change: transform, opacity;
    pointer-events:none;
  }
  @keyframes flicker{ 0%{ transform:scale(1) rotate(-1.4deg); opacity:1 } 50%{ transform:scale(1.12) rotate(1.1deg); opacity:.82 } 100%{ transform:scale(1) rotate(-1.2deg); opacity:1 } }

  /* Final stub (no outer shadow per request) */
  .stub{ display:none; position:absolute; bottom:0; width:140px; height:56px; background:linear-gradient(180deg,#8a8a8a,#6b6b6b); border-radius:0 0 20px 20px; box-shadow: inset 0 3px 8px rgba(0,0,0,.25); z-index:1; }
  .smoke{ position:absolute; width:10px; height:10px; left:0; top:0; border-radius:50%; background:radial-gradient(#bbb, transparent 64%); opacity:0; pointer-events:none; z-index:7; }
  .smoke.show{ animation:puff 1.6s ease-out forwards; }
  @keyframes puff{ 0%{ transform:translate(0,0) scale(1); opacity:.8; filter:blur(.5px) } 100%{ transform:translate(0,-130px) scale(2.2); opacity:0; filter:blur(3px) } }

  /* Controls */
  #controls{ position:relative; display:grid; grid-auto-flow:column; grid-auto-columns:minmax(240px,1fr); gap:14px; padding:16px; background:rgba(0,0,0,.22); backdrop-filter:blur(8px); scroll-snap-type:x mandatory; overflow-x:auto; border-top-left-radius:16px; border-top-right-radius:16px; z-index:10; }
  .card{ position:relative; scroll-snap-align:start; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; min-height:84px; display:flex; flex-direction:column; gap:8px; }
  /* Back “shine” for cards */
  .card::before{ content:""; position:absolute; inset:-8px; z-index:-1; border-radius:18px; background: radial-gradient(60% 60% at 50% 40%, rgba(255,255,255,.20), rgba(255,255,255,0)); filter: blur(12px); }

  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  label{ font-size:12px; opacity:.95 }
  input[type="number"],input[type="color"],input[type="file"],select{ width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.35); color:#fff; outline:none; }
  input[type="checkbox"]{ transform:scale(1.2) }

  /* Buttons: new font + glow behind (shiny from back) */
  .btn{ position:relative; padding:12px 18px; border-radius:12px; border:none; font-weight:800; cursor:pointer; font-family: var(--btn-font); background:var(--btn-grad); color:#1b1b1b; box-shadow:0 6px 16px rgba(0,0,0,.18); transition:transform .12s, box-shadow .2s, background .2s; }
  .btn::before{ content:""; position:absolute; inset:-6px; z-index:-1; border-radius:14px; background: radial-gradient(40% 60% at 50% 20%, rgba(255,255,255,.35), rgba(255,255,255,0)); filter: blur(10px); }
  .btn:hover{ background:var(--btn-grad-hover); box-shadow:0 10px 24px rgba(0,0,0,.28); }
  .btn:active{ transform: translateY(1px) scale(.99); }
  .btn.alt{ background:linear-gradient(135deg,#a5b4fc,#6366f1); color:#0d0d15; }
  .btn.alt:hover{ background:linear-gradient(135deg,#c7d2fe,#818cf8); }
  .btn.warn{ background:linear-gradient(135deg,#fca5a5,#ef4444); color:#0d0d15; }
  .btn.warn:hover{ background:linear-gradient(135deg,#fecaca,#f87171); }

  .small{ font-size:12px; opacity:.9 }

  /* Fullscreen */
  .fullscreen-on .brand,.fullscreen-on #controls{ display:none }
  .fullscreen-on #exitFs{ display:block }
  .fullscreen-on .main{ padding:10px min(3vw,28px) }
  .fullscreen-on :root{ --digit-w:140px; --digit-h:200px; }

  /* Real-time clock overlay */
  #rtcOverlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25); backdrop-filter: blur(2px); z-index:90; }
  #rtcOverlay.show{ display:flex; }
  #rtcClock{ font-family: "Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; font-weight:900; letter-spacing:.5px; font-size:min(12vw, 120px); color:#fff; text-shadow:0 6px 24px rgba(0,0,0,.45); }
  #rtcStop{ position:fixed; top:8px; right:10px; opacity:.35; background:rgba(0,0,0,.25); color:#fff; border-radius:10px; padding:6px 10px; font-weight:800; border:none; cursor:pointer; z-index:95; }
  #rtcStop:hover{ opacity:.65 }

  @media (max-width:980px){ :root{ --digit-w:100px; --digit-h:140px; } }
  @media (max-width:720px){ :root{ --digit-w:86px; --digit-h:120px; } }
</style>
</head>
<body>
  <div class="brand">MADE BY ANABRATA</div>
  <div id="exitFs" title="Exit fullscreen">×</div>

  <div class="main" id="main">
    <!-- Clock -->
    <section id="timer-container" aria-label="Flip clock">
      <div id="timer"></div>
    </section>

    <!-- Candle -->
    <section id="candle-area" aria-label="Candle">
      <div class="candle-clip">
        <div class="candle-wrap" id="candleWrap">
          <div class="wax" id="wax">
            <div class="waxTop"></div>
            <div class="wick" id="wick"></div>
          </div>
          <div class="stub" id="stub"></div>
        </div>
      </div>
      <div class="flame" id="flame"></div>
      <div class="smoke" id="smoke"></div>
    </section>
  </div>

  <!-- Real-time clock overlay -->
  <div id="rtcOverlay">
    <div id="rtcClock">00:00:00</div>
    <button id="rtcStop" title="Close">Stop</button>
  </div>

  <!-- Controls -->
  <div id="controls">
    <div class="card">
      <label class="small">Timer</label>
      <div class="row">
        <div style="flex:1"><label for="hoursInput">Hours</label><input id="hoursInput" type="number" min="0" value="0"></div>
        <div style="flex:1"><label for="minInput">Minutes</label><input id="minInput" type="number" min="0" value="1"></div>
        <div style="flex:1"><label for="secInput">Seconds</label><input id="secInput" type="number" min="0" max="59" value="0"></div>
      </div>
      <div class="row">
        <label><input type="checkbox" id="showHours"> Show hours</label>
        <label><input type="checkbox" id="showSeconds" checked> Show seconds</label>
        <label><input type="checkbox" id="rtcMode"> Real‑time clock mode</label>
      </div>
      <div class="row">
        <button id="startBtn" class="btn">Start</button>
        <button id="toggleBtn" class="btn alt" title="Stop/Resume">Stop</button>
        <button id="resetBtn" class="btn alt">Reset</button>
        <button id="fsBtn" class="btn warn">Fullscreen</button>
      </div>
    </div>

    <div class="card">
      <label class="small">Background</label>
      <div class="row">
        <div style="flex:1"><label for="bgAngle">Angle</label><input id="bgAngle" type="number" min="0" max="360" value="135"></div>
        <div style="flex:1"><label for="bgC1">Color 1</label><input id="bgC1" type="color" value="#3a1c71"></div>
        <div style="flex:1"><label for="bgC2">Color 2</label><input id="bgC2" type="color" value="#d76d77"></div>
        <div style="flex:1"><label for="bgC3">Color 3</label><input id="bgC3" type="color" value="#ffaf7b"></div>
      </div>
      <div class="row">
        <div style="flex:2"><label for="bgImageInput">Personal image</label><input id="bgImageInput" type="file" accept="image/*"></div>
        <div style="flex:1"><button id="clearBgBtn" class="btn alt" type="button">Clear image</button></div>
      </div>
      <span class="small">Upload a photo or use the multicolor gradient above.</span>
    </div>

    <div class="card">
      <label class="small">Flip clock colors</label>
      <div class="row">
        <div style="flex:1"><label for="clockC1">Panel 1</label><input id="clockC1" type="color" value="#0e0f13"></div>
        <div style="flex:1"><label for="clockC2">Panel 2</label><input id="clockC2" type="color" value="#242631"></div>
        <div style="flex:1"><label for="clockC3">Panel 3</label><input id="clockC3" type="color" value="#3b3e4b"></div>
      </div>
      <div class="row">
        <div style="flex:1"><label for="textColor">Digit color</label><input id="textColor" type="color" value="#ffffff"></div>
        <div style="flex:1"><label for="colonColor">Colon color</label><input id="colonColor" type="color" value="#ffffff"></div>
      </div>
    </div>

    <div class="card">
      <label class="small">Candle</label>
      <div class="row">
        <div style="flex:1"><label for="waxColor">Wax color</label><input id="waxColor" type="color" value="#efe0c2"></div>
      </div>
      <span class="small">Flame burns during countdown and fully turns off at 0.</span>
    </div>
  </div>

<script>
  const $ = s => document.querySelector(s);

  /* Background helpers */
  const gradientStr = (angle,c1,c2,c3) => `linear-gradient(${angle}deg, ${c1}, ${c2}${c3 ? ', '+c3 : ''})`;

  /* Flip clock core */
  const timerEl = $('#timer');

  function createDigit(initial="0"){
    const d = document.createElement('div');
    d.className = 'digit';
    d.dataset.value = initial;

    const top = document.createElement('div');
    top.className = 'top';
    const tVal = document.createElement('span');
    tVal.className = 'value';
    tVal.textContent = initial;
    top.appendChild(tVal);

    const bottom = document.createElement('div');
    bottom.className = 'bottom';
    const bVal = document.createElement('span');
    bVal.className = 'value';
    bVal.textContent = initial;
    bottom.appendChild(bVal);

    d.appendChild(top); d.appendChild(bottom);
    return d;
  }

  function flipTo(digitEl, newVal){
    const current = digitEl.dataset.value || "0";
    if (current === newVal) return;

    const topVal = digitEl.querySelector('.top .value');
    const botVal = digitEl.querySelector('.bottom .value');

    // Top half flips first; bottom opens after top finishes for perfect sync
    const topFlip = document.createElement('div');
    topFlip.className = 'top-flip';
    const topFlipVal = document.createElement('span');
    topFlipVal.className = 'value';
    topFlipVal.textContent = current;
    topFlip.appendChild(topFlipVal);

    topVal.textContent = current; botVal.textContent = current;
    digitEl.appendChild(topFlip);

    topFlip.addEventListener('animationend', () => {
      topVal.textContent = newVal;
      topFlip.remove();

      const bottomFlip = document.createElement('div');
      bottomFlip.className = 'bottom-flip';
      const bottomFlipVal = document.createElement('span');
      bottomFlipVal.className = 'value';
      bottomFlipVal.textContent = newVal;
      bottomFlip.appendChild(bottomFlipVal);
      digitEl.appendChild(bottomFlip);

      bottomFlip.addEventListener('animationend', () => {
        botVal.textContent = newVal;
        digitEl.dataset.value = newVal;
        bottomFlip.remove();
      });
    });
  }

  let digits = [], colonEls = [];
  function setupDigits(showH, showS){
    timerEl.innerHTML = ''; digits = []; colonEls = [];
    const addDigit = () => { const d = createDigit("0"); timerEl.appendChild(d); digits.push(d); };
    const addColon = () => { const c = document.createElement('div'); c.className='colon'; c.textContent=':'; timerEl.appendChild(c); colonEls.push(c); };

    if (showH){ addDigit(); addDigit(); addColon(); }
    addDigit(); addDigit();
    if (showS){ addColon(); addDigit(); addDigit(); }
    restyleClockPanels();
  }

  const timeToArray = (sec, showH, showS) => {
    let h = Math.floor(sec/3600);
    let m = Math.floor((sec%3600)/60);
    let s = sec % 60;
    h = Math.min(h, 99);
    const arr = [];
    if (showH) arr.push(...String(h).padStart(2,'0'));
    arr.push(...String(m).padStart(2,'0'));
    if (showS) arr.push(...String(s).padStart(2,'0'));
    return arr;
  };

  function updateDisplay(sec){
    const showH = $('#showHours').checked;
    const showS = $('#showSeconds').checked;
    const arr = timeToArray(sec, showH, showS);
    digits.forEach((d,i) => flipTo(d, arr[i] || '0'));
  }

  /* Candle coupling */
  const area = $('#candle-area');
  const waxEl = $('#wax'), wickEl = $('#wick'), flameEl = $('#flame'), stubEl = $('#stub'), smokeEl = $('#smoke');
  const baseWaxHeight = 360; const minStub = 56;

  function positionFlame(){
    const wick = wickEl.getBoundingClientRect();
    const a = area.getBoundingClientRect();
    const x = wick.left + wick.width/2 - a.left - flameEl.offsetWidth/2;
    const y = wick.top - a.top - flameEl.offsetHeight + 20;
    flameEl.style.left = `${x}px`; flameEl.style.top = `${y}px`;
    smokeEl.style.left = `${x + flameEl.offsetWidth/2 - 5}px`;
    smokeEl.style.top = `${y - 2}px`;
  }

  function setWaxHeightByProgress(progress){
    const usable = baseWaxHeight - minStub;
    const h = minStub + Math.max(0, usable * progress);
    waxEl.style.height = `${h}px`;
  }

  function extinguish(){
    flameEl.style.opacity = '0';
    smokeEl.classList.remove('show'); void smokeEl.offsetWidth; smokeEl.classList.add('show');
    stubEl.style.display = 'block';
  }
  function relight(){
    stubEl.style.display = 'none';
    flameEl.style.opacity = '1';
  }

  /* Background + colors */
  function applyBackground(){
    if (!document.body.dataset.bgimg){
      const ang = parseInt($('#bgAngle').value||'135',10);
      const c1 = $('#bgC1').value, c2 = $('#bgC2').value, c3 = $('#bgC3').value;
      document.body.style.backgroundImage = gradientStr(ang,c1,c2,c3);
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundPosition = 'center';
      document.body.style.backgroundRepeat = 'no-repeat';
      document.body.style.backgroundAttachment = 'fixed';
    }
  }
  function restyleClockPanels(){
    const c1 = $('#clockC1').value, c2 = $('#clockC2').value, c3 = $('#clockC3').value, txt = $('#textColor').value;
    document.documentElement.style.setProperty('--clock-c1', c1);
    document.documentElement.style.setProperty('--clock-c2', c2);
    document.documentElement.style.setProperty('--clock-c3', c3);
    document.documentElement.style.setProperty('--clock-text', txt);
    document.documentElement.style.setProperty('--colon-color', $('#colonColor').value);
  }
  function applyWax(){ document.documentElement.style.setProperty('--wax', $('#waxColor').value); }

  // Upload personal background image (cover)
  $('#bgImageInput').addEventListener('change', e=>{
    const f = e.target.files && e.target.files;
    if (!f) return;
    const r = new FileReader();
    r.onload = () => {
      document.body.dataset.bgimg = '1';
      document.body.style.backgroundImage = `url('${r.result}')`;
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundPosition = 'center';
      document.body.style.backgroundRepeat = 'no-repeat';
      document.body.style.backgroundAttachment = 'fixed';
    };
    r.readAsDataURL(f);
  });
  $('#clearBgBtn').addEventListener('click', ()=>{
    delete document.body.dataset.bgimg;
    applyBackground();
  });

  /* Fullscreen */
  async function goFullscreen(){
    try{
      if (!document.fullscreenElement){ await document.documentElement.requestFullscreen(); }
      document.body.classList.add('fullscreen-on');
      $('#exitFs').style.display = 'block';
    }catch(e){}
  }
  function exitFullscreen(){
    document.exitFullscreen?.();
    document.body.classList.remove('fullscreen-on');
    $('#exitFs').style.display = 'none';
  }
  $('#fsBtn').addEventListener('click', goFullscreen);
  $('#exitFs').addEventListener('click', exitFullscreen);
  document.addEventListener('fullscreenchange', ()=>{
    if (!document.fullscreenElement){ document.body.classList.remove('fullscreen-on'); $('#exitFs').style.display='none'; }
  });

  /* Real-time clock mode */
  const rtcOverlay = $('#rtcOverlay');
  const rtcClock = $('#rtcClock');
  let rtcOn = false, rtcId = null;
  function drawRTC(){
    const now = new Date();
    rtcClock.textContent = now.toLocaleTimeString();
    if (rtcOn) rtcId = requestAnimationFrame(drawRTC);
  }
  function openRTC(){
    rtcOn = true; rtcOverlay.classList.add('show'); cancelAnimationFrame(rafId); running=false;
    rtcId = requestAnimationFrame(drawRTC);
    $('#main').style.display='none';
  }
  function closeRTC(){
    rtcOn = false; rtcOverlay.classList.remove('show'); cancelAnimationFrame(rtcId);
    $('#main').style.display='';
  }
  $('#rtcMode').addEventListener('change', e => e.target.checked ? openRTC() : closeRTC());
  $('#rtcStop').addEventListener('click', ()=>{ $('#rtcMode').checked=false; closeRTC(); });

  /* rAF-driven countdown with Stop/Resume */
  let totalSec = 0, rafId = null, endAtMs = 0, lastWhole = -1, running = false, paused = false, pauseRemainMs = 0;

  function start(){
    const h = Math.max(0, parseInt($('#hoursInput').value||'0',10));
    const m = Math.max(0, parseInt($('#minInput').value||'0',10));
    const s = Math.max(0, Math.min(59, parseInt($('#secInput').value||'0',10)));
    const showH = $('#showHours').checked;
    const showS = $('#showSeconds').checked;

    totalSec = h*3600 + m*60 + s;
    setupDigits(showH, showS);
    updateDisplay(totalSec);
    relight();
    setWaxHeightByProgress(1);
    positionFlame();

    cancelAnimationFrame(rafId);
    paused = false; $('#toggleBtn').textContent = 'Stop';
    if (totalSec <= 0){ setWaxHeightByProgress(0); extinguish(); running=false; return; }
    endAtMs = performance.now() + totalSec*1000;
    lastWhole = Math.ceil(totalSec); running = true;
    rafId = requestAnimationFrame(loop);
  }

  function loop(now){
    if (!running) return;
    const remainingMs = Math.max(0, endAtMs - now);
    const secWhole = Math.floor(remainingMs/1000);
    if (secWhole !== lastWhole){
      updateDisplay(secWhole);
      lastWhole = secWhole;
    }
    const p = totalSec > 0 ? remainingMs / (totalSec*1000) : 0;
    setWaxHeightByProgress(p);
    positionFlame();

    if (remainingMs <= 0){
      extinguish();
      running = false;
      return;
    }
    rafId = requestAnimationFrame(loop);
  }

  function toggleStop(){
    if (!running && !paused) return;
    if (!paused){
      // Pause
      cancelAnimationFrame(rafId);
      pauseRemainMs = Math.max(0, endAtMs - performance.now());
      paused = true; running = false;
      $('#toggleBtn').textContent = 'Resume';
    }else{
      // Resume
      endAtMs = performance.now() + pauseRemainMs;
      lastWhole = Math.floor(pauseRemainMs/1000);
      paused = false; running = true;
      $('#toggleBtn').textContent = 'Stop';
      rafId = requestAnimationFrame(loop);
    }
  }

  function reset(){
    cancelAnimationFrame(rafId); running=false; paused=false; $('#toggleBtn').textContent='Stop';
    start(); cancelAnimationFrame(rafId); running=false; paused=false;
  }

  // UI
  $('#startBtn').addEventListener('click', start);
  $('#toggleBtn').addEventListener('click', toggleStop);
  $('#resetBtn').addEventListener('click', reset);
  $('#showHours').addEventListener('change', ()=>{ setupDigits($('#showHours').checked, $('#showSeconds').checked); updateDisplay(lastWhole>0?lastWhole:0); });
  $('#showSeconds').addEventListener('change', ()=>{ setupDigits($('#showHours').checked, $('#showSeconds').checked); updateDisplay(lastWhole>0?lastWhole:0); });

  ['bgAngle','bgC1','bgC2','bgC3'].forEach(id => document.getElementById(id).addEventListener('input', applyBackground));
  ['clockC1','clockC2','clockC3','textColor','colonColor'].forEach(id => document.getElementById(id).addEventListener('input', restyleClockPanels));
  $('#waxColor').addEventListener('input', applyWax);
  window.addEventListener('resize', positionFlame);

  // Init
  applyBackground();
  restyleClockPanels();
  applyWax();
  setupDigits(false,true); updateDisplay(60);
  setWaxHeightByProgress(1); relight(); positionFlame();
</script>
</body>
</html>

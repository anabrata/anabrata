<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Candle Timer — V5</title>
<style>
  :root{
    /* Fixed digit sizes to prevent shrinking */
    --digit-w: 120px;
    --digit-h: 170px;
    --digit-radius: 16px;
    --split-line: rgba(0,0,0,0.08);

    /* Spacing */
    --gap: clamp(24px, 5vw, 56px);

    /* Background gradient (fallback if no custom image) */
    --bg-angle: 135deg;
    --bg-c1: #3a1c71;
    --bg-c2: #d76d77;
    --bg-c3: #ffaf7b;

    /* Flip clock colors */
    --clock-c1: #ffffff;
    --clock-c2: #ffffff;
    --clock-c3: #ffffff;
    --clock-text: #000000;
    --colon-color: #ffffff;

    /* Simple (non‑flip) clock */
    --simple-color: #ffffff;

    /* Candle */
    --wax: #f2e4c7;
    --wick: #1b1b1b;

    /* Layout tweak */
    --candle-offset: 18px;

    /* To‑do base bg (transparent by default) */
    --todo-bg: transparent;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; display:flex; flex-direction:column; color:#111;
    font-family:"Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background-image: linear-gradient(var(--bg-angle), var(--bg-c1), var(--bg-c2), var(--bg-c3));
    background-attachment: fixed; background-size: cover; background-position: center;
  }

  .brand{
    position:fixed; left:12px; top:10px; z-index:40; color:#fff;
    font-weight:800; font-size:13px; letter-spacing:.3px;
    text-shadow:0 1px 2px rgba(0,0,0,.35); user-select:none;
  }

  /* ===== Main row: Clock | To‑do | Candle ===== */
  .main{
    flex:1;
    display:grid;
    grid-template-columns: max-content auto max-content; /* clock | todo | candle */
    align-items:center;
    column-gap: var(--gap);
    padding:22px min(5vw,48px);
    position:relative;
  }
  #timer-container{ grid-column:1; }
  #todo-panel     { grid-column:2; justify-self:center; align-self:center; }
  #candle-area    { grid-column:3; }

  /* Center‑clock overlays the middle; To‑do goes LEFT */
  .center-clock .main{ grid-template-columns: 1fr 0 1fr; }
  .center-clock #timer-container{
    position:absolute; left:50%; top:50%;
    transform:translate(-50%,-50%); z-index:5; min-width:0; width:auto;
  }
  .center-clock #todo-panel{
    position:absolute; left:min(48px,5vw); top:50%;
    transform:translateY(-50%); justify-self:start;
    z-index:6; /* keep todo above centered clock edges */
  }

  /* Hide candle → To‑do occupies RIGHT always (replaces candle) */
  .candle-off #candle-area{ display:none !important; }
  .candle-off .main{ grid-template-columns: max-content max-content; }
  .candle-off #todo-panel{
    position:static !important; left:auto !important; top:auto !important; transform:none !important; justify-self:end !important;
  }
  /* Center‑clock + candle‑off → keep To‑do LEFT */
  .center-clock.candle-off #todo-panel{
    position:absolute !important; left:min(48px,5vw) !important; top:50% !important;
    transform:translateY(-50%) !important; justify-self:start !important;
    z-index:6 !important;
  }

  /* Only candle → center candle, hide clock, To‑do LEFT */
  .only-candle #timer-container{ display:none !important; }
  .only-candle .main{ grid-template-columns: auto max-content; }
  .only-candle #todo-panel{
    position:absolute; left:min(48px,5vw); top:50%;
    transform:translateY(-50%); justify-self:start;
    z-index:6;
  }
  /* Ensure candle is explicitly centered in the second column in only-candle mode */
  .only-candle #candle-area{
    grid-column: 2;
    justify-self: center;
  }

  /* ===== To‑do panel ===== */
  #todo-panel{ display:none; }
  .todo-on #todo-panel{ display:block; }

  #todo-panel{
    max-width: clamp(220px, 26vw, 420px);
    max-height: 60vh;
    font-size: 13px;
    overflow:auto; padding:10px 12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.18);
    background: var(--todo-bg, transparent);
    box-shadow: 0 6px 18px rgba(0,0,0,.16), 0 2px 5px rgba(0,0,0,.1);
    color:#fff;
  }
  #todo-panel.todo-clear{
    background: transparent !important; border-color: transparent !important; box-shadow: none !important;
  }
  /* Optional glass transparency to match menu */
  #todo-panel.todo-glass{
    background: rgba(255,255,255,.06) !important;
    border:1px solid rgba(255,255,255,.12) !important;
    box-shadow: 0 8px 24px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.12) !important;
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  }

  #todoTitle{ margin:0 0 6px 0; font-size:12.5px; font-weight:900; letter-spacing:.35px; opacity:.95; }
  #todoList{ margin:0; padding:4px 4px 4px 8px; list-style:none; counter-reset:tdn; font-family:inherit; }
  #todoList li{ counter-increment:tdn; position:relative; padding-left:28px; margin:4px 0; min-height:20px; outline:none; transition: opacity .18s, transform .18s; }
  #todoList li:before{ content: counter(tdn) "."; position:absolute; left:0; top:0; width:22px; text-align:right; padding-right:6px; font-weight:900; opacity:.9; }
  #todoList li.vanish{ opacity:0; transform:translateY(-3px); }
  .todoItem{ display:flex; align-items:center; gap:8px; }
  .todoChk{ appearance:none; width:16px; height:16px; border:2px solid rgba(255,255,255,.75); border-radius:4px; background:transparent; cursor:pointer; }
  .todoChk:checked{ background:#22c55e; border-color:#22c55e; }
  .todoChk:checked::after{ content:""; position:absolute; inset:0; background:linear-gradient(45deg,transparent 47%,#fff 47% 53%,transparent 53%),linear-gradient(-45deg,transparent 47%,#fff 47% 53%,transparent 53%); transform:scale(.48); }
  .todoText{ display:inline-block; min-width:36px; min-height:20px; padding:1px 5px; border-radius:6px; outline:none; color:#fff; caret-color:#fff; }
  .todoText:empty:before{ content:"New task"; opacity:.45; }

  /* ===== Flip clock ===== */
  #timer{ display:flex; align-items:center; gap:12px; user-select:none; }
  .digit{
    position:relative; width:var(--digit-w); height:var(--digit-h); perspective:1200px; border-radius:var(--digit-radius); overflow:hidden;
    background: linear-gradient(145deg,var(--clock-c1),var(--clock-c2),var(--clock-c3));
    box-shadow: inset 0 -1px 0 rgba(0,0,0,.05), inset 0 1px 0 rgba(0,0,0,.12);
    flex:0 0 auto;
  }
  .digit .top,.digit .bottom{ position:absolute; left:0; right:0; height:50%; overflow:hidden; backface-visibility:hidden; -webkit-backface-visibility:hidden; }
  .digit .top{ top:0; border-bottom:1px solid var(--split-line); }
  .digit .bottom{ bottom:0; border-top:1px solid var(--split-line); }
  .value{ position:absolute; left:0; right:0; height:var(--digit-h); display:flex; align-items:center; justify-content:center; font-weight:900; color:var(--clock-text); font-size: calc(var(--digit-h)*.70); line-height:var(--digit-h); }
  .top .value,.top-flip .value{ clip-path: inset(0 0 50% 0); transform: translateY(0); }
  .bottom .value,.bottom-flip .value{ clip-path: inset(50% 0 0 0); transform: translateY(-50%); }
  .top-flip,.bottom-flip{ position:absolute; left:0; right:0; height:50%; overflow:hidden; backface-visibility:hidden; -webkit-backface-visibility:hidden; background:inherit; }
  .top-flip{ top:0; transform-origin:bottom; border-bottom:1px solid var(--split-line); animation: topFlip .26s ease-in forwards; }
  .bottom-flip{ bottom:0; transform-origin:top; border-top:1px solid var(--split-line); animation: bottomFlip .26s ease-out forwards; }
  @keyframes topFlip{ 0%{transform:rotateX(0)} 100%{transform:rotateX(-90deg)} }
  @keyframes bottomFlip{ 0%{transform:rotateX(90deg)} 100%{transform:rotateX(0)} }
  .colon{ display:flex; align-items:center; justify-content:center; width:calc(var(--digit-w)*.33); height:var(--digit-h); font-size:calc(var(--digit-h)*.6); font-weight:900; color:var(--colon-color); text-shadow:0 2px 6px rgba(0,0,0,.25); flex:0 0 auto; }

  /* ===== Simple clock ===== */
  #simpleTimer{ display:none; font-weight:900; letter-spacing:.04em; font-size:min(12vw,160px); color:var(--simple-color); text-shadow:0 0 10px rgba(0,0,0,.25), 0 12px 32px rgba(0,0,0,.25); }

  /* ===== Candle ===== */
  #candle-area{ display:flex; align-items:flex-end; justify-content:flex-end; height:max(380px,42vh); position:relative; transform: translateY(var(--candle-offset)); }
  .candle-clip{ position:relative; width:180px; height:380px; overflow:hidden; display:flex; align-items:flex-end; justify-content:center; }
  .candle-wrap{ position:absolute; inset:auto 0 0 0; margin:auto; width:180px; height:380px; display:flex; align-items:flex-end; justify-content:center; transition: transform .5s ease, opacity .5s ease; }
  .candle-wrap.vanish{ transform: scale(.85) translateY(12px); opacity: 0; pointer-events:none; }
  .wax{ position:absolute; bottom:0; width:150px; height:100%; z-index:1; border-radius:22px; background: radial-gradient(120px 26px at 75px 6px, rgba(255,255,255,.70), transparent 62%), linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,0) 24%), linear-gradient(180deg,#ffffff33,#00000022 40%,#00000028 100%), linear-gradient(180deg,var(--wax), #e6d9bb); transition: height .22s linear; }
  .waxTop{ position:absolute; top:-22px; left:50%; transform:translateX(-50%); width:150px; height:44px; pointer-events:none; z-index:3; background: conic-gradient(from 0deg at 50% 50%, rgba(255,255,255,.33) 0deg, rgba(255,255,255,.10) 70deg, rgba(0,0,0,.08) 180deg, rgba(255,255,255,.20) 300deg, rgba(255,255,255,.33) 360deg), radial-gradient(65% 55% at 50% 62%, rgba(255,255,255,.52), rgba(255,255,255,.12) 60%, rgba(0,0,0,.10) 100%); border-radius:50%/62% 62% 38% 38%; }
  .wax:after{ content:""; position:absolute; top:30px; left:24px; width:12px; height:64px; border-radius:10px; background: linear-gradient(180deg,#fff6,#0000 60%), var(--wax); box-shadow: 44px 8px 0 -3px var(--wax), 44px 8px 0 -3px #fff6, 92px 12px 0 -6px var(--wax), 92px 12px 0 -6px #fff6; opacity:.85; }
  .wick{ position:absolute; width:6px; height:30px; background:linear-gradient(180deg,#444,var(--wick)); border-radius:4px; top:-12px; left:50%; transform:translateX(-50%); z-index:4; }
  .flame{ position:absolute; width:52px; height:110px; z-index:6; pointer-events:none; background: radial-gradient(ellipse at 50% 22%, #fff7c0 0%, #ffe08a 38%, #ffb347 58%, #ff7a00 78%, transparent 80%), radial-gradient(ellipse at 50% 45%, #ffffff 0%, transparent 65%); border-radius:50% 50% 38% 38%; box-shadow:0 0 18px 6px rgba(255,170,40,.55), 0 0 36px 14px rgba(255,140,0,.40), 0 -20px 28px rgba(255,220,170,.40); animation: flickerSoft .6s ease-in-out infinite; left:0; top:0; will-change:left,top; }
  @keyframes flickerSoft{ 0%{ transform:scale(1) rotate(-0.8deg); opacity:.95 } 50%{ transform:scale(1.06) rotate(0.6deg); opacity:.82 } 100%{ transform:scale(1) rotate(-0.8deg); opacity:.95 } }
  .flame.off{ opacity:0 !important; animation-play-state: paused !important; }
  .stub{ display:none; position:absolute; bottom:0; width:150px; height:58px; background:linear-gradient(180deg,#9a9a9a,#6f6f6f); border-radius:0 0 22px 22px; z-index:1; }

  /* ===== Controls (glass) ===== */
  #controls{
    position:relative; display:grid; grid-auto-flow:column; grid-auto-columns:minmax(260px,1fr); gap:14px; padding:16px;
    background:rgba(0,0,0,.22); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
    overflow-x:auto; border-top-left-radius:16px; border-top-right-radius:16px; z-index:10; min-height:200px;
  }
  .card{
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; min-height:164px;
    display:flex; flex-direction:column; gap:8px; backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
  }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  label{ font-size:12px; color:#fff; opacity:.95 }
  input[type="number"],input[type="color"],input[type="file"]{
    width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.35); color:#fff; outline:none;
  }
  input[type="checkbox"]{ transform:scale(1.2) }
  .btn{ padding:12px 18px; border-radius:12px; border:none; font-weight:800; cursor:pointer; font-family:inherit; background:linear-gradient(135deg,#ffd166,#ff9a00); color:#1b1b1b; box-shadow:0 6px 16px rgba(0,0,0,.18); transition:transform .12s, box-shadow .2s, background .2s; }
  .btn:hover{ background:linear-gradient(135deg,#ffe08a,#ffb347); box-shadow:0 10px 24px rgba(0,0,0,.28); }
  .btn:active{ transform: translateY(1px) scale(.99); }
  .btn.alt{ background:linear-gradient(135deg,#a5b4fc,#6366f1); color:#0d0d15; }
  .btn.warn{ background:linear-gradient(135deg,#fca5a5,#ef4444); color:#0d0d15; }
  .btn.small{ padding:8px 10px; border-radius:10px; font-weight:900; }
  .btn.wide{ min-width:110px; }

  @media (max-width:980px){
    :root{ --digit-w:100px; --digit-h:140px; }
    #todo-panel{ max-width:62vw; }
  }
  @media (max-width:720px){
    :root{ --digit-w:86px; --digit-h:120px; }
    #todo-panel{ max-width:72vw; }
  }

  /* Utility to eliminate transitions/animations during snap resets */
  .no-transitions, .no-transitions *{
    transition: none !important;
    animation: none !important;
  }
</style>
</head>
<body>
  <div class="brand">MADE BY ANABRATA — V5</div>

  <div class="main" id="main">
    <!-- Timer -->
    <section id="timer-container" aria-label="Timer">
      <div id="timer"></div>
      <div id="simpleTimer">00:00</div>
    </section>

    <!-- To‑do -->
    <section id="todo-panel" class="todo-clear" aria-label="To‑do list">
      <h4 id="todoTitle">To‑do</h4>
      <ol id="todoList"></ol>
    </section>

    <!-- Candle -->
    <section id="candle-area" aria-label="Candle">
      <div class="candle-clip">
        <div class="candle-wrap" id="candleWrap">
          <div class="wax" id="wax">
            <div class="waxTop"></div>
            <div class="wick" id="wick"></div>
          </div>
          <div class="stub" id="stub"></div>
        </div>
      </div>
      <div class="flame" id="flame"></div>
    </section>
  </div>

  <!-- Controls -->
  <div id="controls">
    <div class="card">
      <label class="small">Timer</label>
      <div class="row">
        <div style="flex:1"><label for="hoursInput">Hours</label><input id="hoursInput" type="number" min="0" value="0"></div>
        <div style="flex:1"><label for="minInput">Minutes</label><input id="minInput" type="number" min="0" value="1"></div>
        <div style="flex:1"><label for="secInput">Seconds</label><input id="secInput" type="number" min="0" max="59" value="0"></div>
      </div>
      <div class="row">
        <label><input type="checkbox" id="showHours"> Show hours</label>
        <label><input type="checkbox" id="showSeconds" checked> Show seconds</label>
        <label><input type="checkbox" id="useFlip" checked> Use flip style</label>
      </div>
      <div class="row">
        <button id="primaryBtn" class="btn wide">Start</button>
        <button id="resetBtn" class="btn alt wide">Reset</button>
        <button id="fsBtn" class="btn warn wide">Fullscreen</button>
      </div>
    </div>

    <div class="card">
      <label class="small">Background gradient</label>
      <div class="row">
        <div style="flex:1"><label for="bgAngle">Angle</label><input id="bgAngle" type="number" min="0" max="360" value="135"></div>
        <div style="flex:1"><label for="bgC1">Color 1</label><input id="bgC1" type="color" value="#3a1c71"></div>
        <div style="flex:1"><label for="bgC2">Color 2</label><input id="bgC2" type="color" value="#d76d77"></div>
        <div style="flex:1"><label for="bgC3">Color 3</label><input id="bgC3" type="color" value="#ffaf7b"></div>
      </div>
      <div class="row">
        <div style="flex:1; display:flex; gap:8px; align-items:center">
          <div style="flex:1">
            <label for="todoColor">To‑do list color</label>
            <input id="todoColor" type="color" value="#ffffff">
          </div>
          <button id="todoApply" class="btn small">Apply</button>
          <button id="todoClear" class="btn small" title="Transparent">Clear</button>
        </div>
      </div>
      <div class="row">
        <label><input type="checkbox" id="todoGlass"> To‑do transparency effect</label>
      </div>
    </div>

    <div class="card">
      <label class="small">Media & background</label>
      <div class="row" style="gap:8px; align-items:center">
        <button id="addMusicBtn" class="btn alt small">Add music</button>
        <input id="musicFiles" type="file" accept="audio/*" multiple style="display:none" />
        <button id="musicPrev" class="btn small" title="Previous">⏮</button>
        <button id="musicPlay" class="btn small" title="Play/Pause">▶</button>
        <button id="musicNext" class="btn small" title="Next">⏭</button>
        <label style="margin-left:4px"><input type="checkbox" id="musicLoop" checked> Loop</label>
        <span id="musicNow" style="color:#fff; font-size:12px; opacity:.95; max-width:220px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis"></span>
      </div>
      <div class="row" style="gap:8px; align-items:center; margin-top:6px">
        <button id="bgImageBtn" class="btn small">Custom image</button>
        <input id="bgImageFile" type="file" accept="image/*" style="display:none" />
        <button id="bgImageClear" class="btn small">Clear image</button>
        <span id="bgImageName" style="color:#fff; font-size:12px; opacity:.95; max-width:240px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis"></span>
      </div>
    </div>

    <div class="card">
      <label class="small">Flip clock colors</label>
      <div class="row">
        <div style="flex:1"><label for="clockC1">Panel 1</label><input id="clockC1" type="color" value="#ffffff"></div>
        <div style="flex:1"><label for="clockC2">Panel 2</label><input id="clockC2" type="color" value="#ffffff"></div>
        <div style="flex:1"><label for="clockC3">Panel 3</label><input id="clockC3" type="color" value="#ffffff"></div>
      </div>
      <div class="row">
        <div style="flex:1"><label for="textColor">Digit color</label><input id="textColor" type="color" value="#000000"></div>
        <div style="flex:1"><label for="colonColor">Colon color</label><input id="colonColor" type="color" value="#ffffff"></div>
      </div>
    </div>

    <div class="card">
      <label class="small">Layout</label>
      <div class="row">
        <label><input type="checkbox" id="hideCandle"> Hide candle</label>
        <label><input type="checkbox" id="centerClock"> Center clock</label>
        <label><input type="checkbox" id="onlyCandle"> Only candle mode</label>
        <label><input type="checkbox" id="showTodo" checked> Show to‑do list</label>
      </div>
    </div>
  </div>

<script>
  const $ = (s) => document.querySelector(s);

  /* ---------- Utilities ---------- */
  function afterNextPaint(cb){
    requestAnimationFrame(() => requestAnimationFrame(cb));
  }

  /* ---------- Background & colors ---------- */
  const gradientStr = (a, c1, c2, c3) => `linear-gradient(${a}deg, ${c1}, ${c2}, ${c3})`;
  let bgObjectUrl = null;

  function applyGradient(){
    if (bgObjectUrl){
      URL.revokeObjectURL(bgObjectUrl);
      bgObjectUrl = null;
      $("#bgImageName").textContent = "";
    }
    const ang = parseInt($("#bgAngle").value || "135", 10);
    document.body.style.backgroundImage = gradientStr(ang, $("#bgC1").value, $("#bgC2").value, $("#bgC3").value);
    document.body.style.backgroundSize = "cover";
    document.body.style.backgroundPosition = "center";
    document.body.style.backgroundAttachment = "fixed";
  }

  function setTodoBg(val){
    document.documentElement.style.setProperty("--todo-bg", val);
  }

  function applyWax(){
    document.documentElement.style.setProperty("--wax", $("#waxColor")?.value || "#f2e4c7");
  }

  function restyleClockPanels(){
    document.documentElement.style.setProperty("--clock-c1", $("#clockC1").value);
    document.documentElement.style.setProperty("--clock-c2", $("#clockC2").value);
    document.documentElement.style.setProperty("--clock-c3", $("#clockC3").value);
    document.documentElement.style.setProperty("--clock-text", $("#textColor").value);
    document.documentElement.style.setProperty("--colon-color", $("#colonColor").value);
  }

  /* ---------- Flip clock ---------- */
  function createDigit(initial = "0"){
    const d = document.createElement("div");
    d.className = "digit";
    d.dataset.value = initial;

    const top = document.createElement("div");
    top.className = "top";
    const t = document.createElement("span");
    t.className = "value";
    t.textContent = initial;
    top.appendChild(t);

    const bottom = document.createElement("div");
    bottom.className = "bottom";
    const b = document.createElement("span");
    b.className = "value";
    b.textContent = initial;
    bottom.appendChild(b);

    d.appendChild(top);
    d.appendChild(bottom);
    return d;
  }

  function flipTo(digitEl, newVal){
    const cur = digitEl.dataset.value || "0";
    if (cur === newVal) return;

    const topVal = digitEl.querySelector(".top .value");
    const botVal = digitEl.querySelector(".bottom .value");

    const topFlip = document.createElement("div");
    topFlip.className = "top-flip";
    const t = document.createElement("span");
    t.className = "value";
    t.textContent = cur;
    topFlip.appendChild(t);

    topVal.textContent = cur;
    botVal.textContent = cur;
    digitEl.appendChild(topFlip);

    topFlip.addEventListener("animationend", () => {
      topVal.textContent = newVal;
      topFlip.remove();
      const bottomFlip = document.createElement("div");
      bottomFlip.className = "bottom-flip";
      const b = document.createElement("span");
      b.className = "value";
      b.textContent = newVal;
      bottomFlip.appendChild(b);
      digitEl.appendChild(bottomFlip);
      bottomFlip.addEventListener("animationend", () => {
        botVal.textContent = newVal;
        digitEl.dataset.value = newVal;
        bottomFlip.remove();
      });
    });
  }

  function buildFlip(container, showH = true, showS = true){
    container.innerHTML = "";
    const digits = [];
    const addDigit = () => {
      const d = createDigit("0");
      container.appendChild(d);
      digits.push(d);
    };
    const addColon = () => {
      const c = document.createElement("div");
      c.className = "colon";
      c.textContent = ":";
      container.appendChild(c);
    };
    if (showH){
      addDigit(); addDigit(); addColon();
    }
    addDigit(); addDigit();
    if (showS){
      addColon(); addDigit(); addDigit();
    }
    return digits;
  }

  function timeArray(sec, showH, showS){
    let h = Math.floor(sec / 3600);
    let m = Math.floor((sec % 3600) / 60);
    let s = Math.max(0, sec % 60);
    h = Math.min(h, 99);
    const arr = [];
    if (showH) arr.push(...String(h).padStart(2, "0"));
    arr.push(...String(m).padStart(2, "0"));
    if (showS) arr.push(...String(s).padStart(2, "0"));
    return arr;
  }

  function tickFlip(digits, sec, showH, showS){
    const arr = timeArray(sec, showH, showS);
    digits.forEach((d, i) => flipTo(d, arr[i] || "0"));
  }

  /* ---------- Simple clock ---------- */
  function renderSimple(sec){
    const sH = $("#showHours").checked;
    const sS = $("#showSeconds").checked;
    const out = sH
      ? `${String(Math.floor(sec / 3600)).padStart(2, "0")}:${String(Math.floor((sec % 3600) / 60)).padStart(2, "0")}:${String(sec % 60).padStart(2, "0")}`
      : `${String(Math.floor(sec / 60)).padStart(2, "0")}:${String(sec % 60).padStart(2, "0")}`;
    $("#simpleTimer").textContent = out;
  }

  /* ---------- Countdown state (robust) ---------- */
  const timerFlip = $("#timer");
  const timerSimple = $("#simpleTimer");
  const primaryBtn = $("#primaryBtn");

  let flipDigits = [];
  let useFlip = true;
  let totalSec = 0;
  let endAtMs = 0;
  let rafId = null;
  let lastWhole = -1;
  let running = false;
  let paused = false;
  let pauseRemainMs = 0;

  function safeBuildClock(){
    useFlip = $("#useFlip").checked;
    if (useFlip){
      timerFlip.style.display = "flex";
      timerSimple.style.display = "none";
      flipDigits = buildFlip(timerFlip, $("#showHours").checked, $("#showSeconds").checked);
      tickFlip(flipDigits, 0, $("#showHours").checked, $("#showSeconds").checked);
    }else{
      timerFlip.style.display = "none";
      timerSimple.style.display = "block";
      renderSimple(0);
    }
  }

  function startCountdown(){
    const h = Math.max(0, parseInt($("#hoursInput").value || "0", 10));
    const m = Math.max(0, parseInt($("#minInput").value || "0", 10));
    const s = Math.max(0, Math.min(59, parseInt($("#secInput").value || "0", 10)));
    totalSec = h * 3600 + m * 60 + s;

    // Reset candle/flame
    candleWrap.classList.remove("vanish");
    stubEl.style.display = "none";
    flameEl.classList.remove("off");
    setWaxHeightByProgress(1);
    afterNextPaint(positionFlame);

    const showH = $("#showHours").checked;
    const showS = $("#showSeconds").checked;
    if (useFlip){
      flipDigits = buildFlip(timerFlip, showH, showS);
      tickFlip(flipDigits, totalSec, showH, showS);
    }else{
      renderSimple(totalSec);
    }

    cancelAnimationFrame(rafId);
    paused = false;
    running = false;

    if (totalSec <= 0){
      finishNow();
      return;
    }
    endAtMs = performance.now() + totalSec * 1000;
    lastWhole = Math.ceil(totalSec);
    running = true;
    primaryBtn.textContent = "Stop";
    rafId = requestAnimationFrame(loop);
  }

  function loop(now){
    if (!running) return;
    const remainMs = Math.max(0, endAtMs - now);
    const secWhole = Math.floor(remainMs / 1000);

    if (secWhole !== lastWhole){
      if (useFlip){
        tickFlip(flipDigits, secWhole, $("#showHours").checked, $("#showSeconds").checked);
      }else{
        renderSimple(secWhole);
      }
      lastWhole = secWhole;
    }

    const p = totalSec > 0 ? remainMs / (totalSec * 1000) : 0;
    setWaxHeightByProgress(p);
    positionFlame();

    if (remainMs <= 0){
      finishNow();
      return;
    }
    rafId = requestAnimationFrame(loop);
  }

  function togglePrimary(){
    if (!running && !paused){
      startCountdown();
      return;
    }
    if (running){
      cancelAnimationFrame(rafId);
      pauseRemainMs = Math.max(0, endAtMs - performance.now());
      paused = true;
      running = false;
      primaryBtn.textContent = "Resume";
      afterNextPaint(positionFlame);
      return;
    }
    if (paused){
      endAtMs = performance.now() + pauseRemainMs;
      lastWhole = Math.floor(pauseRemainMs / 1000);
      paused = false;
      running = true;
      primaryBtn.textContent = "Stop";
      afterNextPaint(positionFlame);
      rafId = requestAnimationFrame(loop);
    }
  }

  function resetCountdown(){
    cancelAnimationFrame(rafId);
    running = false;
    paused = false;
    primaryBtn.textContent = "Start";
    safeBuildClock();
    snapResetCandle();
    hideCongrats();
  }

  function finishNow(){
    cancelAnimationFrame(rafId);
    running = false;
    paused = false;
    flameEl.classList.add("off");
    candleWrap.classList.add("vanish");
    showCongrats();
    primaryBtn.textContent = "Start";
  }

  /* ---------- Candle & flame positioning ---------- */
  const area = $("#candle-area");
  const waxEl = $("#wax");
  const wickEl = $("#wick");
  const flameEl = $("#flame");
  const candleWrap = $("#candleWrap");
  const stubEl = $("#stub");

  const baseWaxHeight = 380;
  const minStub = 58;
  const FLAME_OFFSET = 10;

  function positionFlame(){
    if (getComputedStyle(area).display === "none") return;
    const a = area.getBoundingClientRect();
    const w = wickEl.getBoundingClientRect();
    const x = w.left + w.width / 2 - a.left - flameEl.offsetWidth / 2;
    const y = w.top - a.top - flameEl.offsetHeight + FLAME_OFFSET;
    flameEl.style.left = `${x}px`;
    flameEl.style.top = `${y}px`;
  }

  function setWaxHeightByProgress(progress){
    const usable = baseWaxHeight - minStub;
    const h = minStub + Math.max(0, usable * progress);
    waxEl.style.height = `${h}px`;
  }

  function snapResetCandle(){
    candleWrap.classList.add("no-transitions");
    waxEl.classList.add("no-transitions");
    candleWrap.classList.remove("vanish");
    stubEl.style.display = "none";
    flameEl.classList.remove("off");
    setWaxHeightByProgress(1);
    void candleWrap.offsetHeight; /* force style flush */
    positionFlame();
    requestAnimationFrame(() => {
      candleWrap.classList.remove("no-transitions");
      waxEl.classList.remove("no-transitions");
    });
  }

  new ResizeObserver(() => requestAnimationFrame(() => positionFlame())).observe(area);
  new MutationObserver(() => requestAnimationFrame(() => positionFlame())).observe(document.body, { attributes: true, attributeFilter: ["class"] });
  waxEl.addEventListener("transitionend", () => requestAnimationFrame(() => positionFlame()));
  window.addEventListener("resize", () => requestAnimationFrame(() => positionFlame()));

  /* ---------- Congrats (optional; guarded) ---------- */
  const congrats = $("#congrats");
  $("#cgClose")?.addEventListener("click", () => { if (congrats) congrats.style.display = "none"; });
  function showCongrats(){ if (congrats) congrats.style.display = "flex"; }
  function hideCongrats(){ if (congrats) congrats.style.display = "none"; }

  /* ---------- Fullscreen: show ONLY #main ---------- */
  async function enterFullscreen(){
    try{
      const target = document.getElementById("main") || document.documentElement;
      if (!document.fullscreenElement){
        await target.requestFullscreen?.();
      }else{
        await document.exitFullscreen?.();
      }
    }catch(e){}
  }
  $("#fsBtn").addEventListener("click", enterFullscreen);
  document.addEventListener("fullscreenchange", () => { /* element fullscreen isolates #main */ });

  /* ---------- To‑do logic ---------- */
  const todoList = $("#todoList");

  function makeTodoItem(text = ""){
    const li = document.createElement("li");
    const label = document.createElement("label");
    label.className = "todoItem";
    const chk = document.createElement("input");
    chk.type = "checkbox";
    chk.className = "todoChk";
    const span = document.createElement("span");
    span.className = "todoText";
    span.contentEditable = "true";
    span.spellcheck = false;
    span.textContent = text;
    label.appendChild(chk);
    label.appendChild(span);
    li.appendChild(label);
    return li;
  }

  function spanFocus(el){
    el.focus();
    const r = document.createRange();
    r.selectNodeContents(el);
    r.collapse(false);
    const s = window.getSelection();
    s.removeAllRanges();
    s.addRange(r);
  }

  function addEmptyIfNeeded(){
    if (!todoList.firstElementChild){
      const li = makeTodoItem("");
      todoList.appendChild(li);
      spanFocus(li.querySelector(".todoText"));
    }
  }

  todoList.addEventListener("keydown", (e) => {
    if (!e.target.classList?.contains("todoText")) return;
    if (e.key === "Enter"){
      if (e.shiftKey) return;
      e.preventDefault();
      const li = e.target.closest("li");
      const n = makeTodoItem("");
      li.after(n);
      spanFocus(n.querySelector(".todoText"));
    }
    if (e.key === "Backspace" && e.target.textContent.trim() === ""){
      const li = e.target.closest("li");
      const prev = li.previousElementSibling?.querySelector(".todoText");
      if (prev){
        e.preventDefault();
        li.remove();
        spanFocus(prev);
      }
      addEmptyIfNeeded();
    }
  });

  todoList.addEventListener("change", (e) => {
    if (!e.target.classList?.contains("todoChk")) return;
    const li = e.target.closest("li");
    li.classList.add("vanish");
    setTimeout(() => {
      li.remove();
      addEmptyIfNeeded();
    }, 160);
  });

  /* ---------- Music ---------- */
  const musicFiles = $("#musicFiles");
  const musicNow = $("#musicNow");
  const musicPlayBtn = $("#musicPlay");
  const audio = new Audio();
  audio.preload = "metadata";

  let playlist = [];
  let trackIndex = 0;
  const objectUrls = new Set();

  function updateNow(){
    musicNow.textContent = playlist.length ? `${trackIndex + 1}/${playlist.length} • ${playlist[trackIndex].name}` : "";
  }

  function loadPlaylist(files){
    objectUrls.forEach((u) => URL.revokeObjectURL(u));
    objectUrls.clear();
    playlist = [];
    trackIndex = 0;
    for (const f of files){
      const url = URL.createObjectURL(f);
      objectUrls.add(url);
      playlist.push({ name: f.name, url });
    }
    updateNow();
    if (playlist.length){
      audio.src = playlist[trackIndex].url;
    }else{
      audio.removeAttribute("src");
    }
  }

  function playTrack(i){
    if (!playlist.length) return;
    trackIndex = (i + playlist.length) % playlist.length;
    audio.src = playlist[trackIndex].url;
    audio.play().catch(() => {});
    updateNow();
    musicPlayBtn.textContent = "⏸";
  }

  function startPlaylist(){
    if (!playlist.length) return;
    if (!audio.src) audio.src = playlist[trackIndex].url;
    audio.play().then(() => musicPlayBtn.textContent = "⏸").catch(() => {});
    updateNow();
  }

  function pausePlaylist(){
    audio.pause();
    musicPlayBtn.textContent = "▶";
  }

  function nextTrack(){ if (playlist.length) playTrack(trackIndex + 1); }
  function prevTrack(){ if (playlist.length) playTrack(trackIndex - 1); }

  audio.addEventListener("ended", () => nextTrack());
  audio.addEventListener("play", () => musicPlayBtn.textContent = "⏸");
  audio.addEventListener("pause", () => musicPlayBtn.textContent = "▶");

  $("#addMusicBtn").addEventListener("click", () => musicFiles.click());
  musicFiles.addEventListener("change", (e) => loadPlaylist(e.target.files));
  $("#musicPlay").addEventListener("click", () => audio.paused ? startPlaylist() : pausePlaylist());
  $("#musicNext").addEventListener("click", nextTrack);
  $("#musicPrev").addEventListener("click", prevTrack);
  window.addEventListener("unload", () => objectUrls.forEach((u) => URL.revokeObjectURL(u)));

  /* ---------- Custom background image ---------- */
  const bgImageBtn = $("#bgImageBtn");
  const bgImageFile = $("#bgImageFile");
  const bgImageClear = $("#bgImageClear");
  const bgImageName = $("#bgImageName");

  bgImageBtn.addEventListener("click", () => bgImageFile.click());
  bgImageFile.addEventListener("change", (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    if (bgObjectUrl){
      URL.revokeObjectURL(bgObjectUrl);
      bgObjectUrl = null;
    }
    bgObjectUrl = URL.createObjectURL(f);
    document.body.style.backgroundImage = `url("${bgObjectUrl}")`;
    document.body.style.backgroundSize = "cover";
    document.body.style.backgroundPosition = "center";
    document.body.style.backgroundAttachment = "fixed";
    bgImageName.textContent = f.name;
  });
  bgImageClear.addEventListener("click", applyGradient);

  /* ---------- Layout flags ---------- */
  function ensureCandleVisibleWhenOnlyCandle(on){
    if (on){
      const hc = $("#hideCandle");
      if (hc.checked){
        hc.checked = false;
        document.body.classList.remove("candle-off");
      }
    }
  }

  function applyLayoutFlags(){
    document.body.classList.toggle("candle-off", $("#hideCandle").checked);
    document.body.classList.toggle("center-clock", $("#centerClock").checked);
    document.body.classList.toggle("only-candle", $("#onlyCandle").checked);
    document.body.classList.toggle("todo-on", $("#showTodo").checked);
    safeBuildClock();
    requestAnimationFrame(() => positionFlame());
  }

  function previewLayout(){
    const sh = $("#showHours").checked;
    const ss = $("#showSeconds").checked;
    const uf = $("#useFlip").checked;
    if (uf){
      flipDigits = buildFlip(timerFlip, sh, ss);
      tickFlip(flipDigits, 0, sh, ss);
    }else{
      renderSimple(0);
    }
    requestAnimationFrame(() => positionFlame());
  }

  /* ---------- Bindings ---------- */
  $("#primaryBtn").addEventListener("click", togglePrimary);
  $("#resetBtn").addEventListener("click", resetCountdown);

  $("#useFlip").addEventListener("change", () => { safeBuildClock(); previewLayout(); });
  $("#showHours").addEventListener("change", previewLayout);
  $("#showSeconds").addEventListener("change", previewLayout);

  $("#hideCandle").addEventListener("change", () => applyLayoutFlags());
  $("#centerClock").addEventListener("change", () => applyLayoutFlags());
  $("#onlyCandle").addEventListener("change", (e) => { ensureCandleVisibleWhenOnlyCandle(e.target.checked); applyLayoutFlags(); });
  $("#showTodo").addEventListener("change", () => applyLayoutFlags());

  ["bgAngle", "bgC1", "bgC2", "bgC3"].forEach((id) => document.getElementById(id).addEventListener("input", applyGradient));
  ["clockC1", "clockC2", "clockC3", "textColor", "colonColor"].forEach((id) => document.getElementById(id).addEventListener("input", restyleClockPanels));

  $("#todoApply").addEventListener("click", () => {
    setTodoBg($("#todoColor").value);
    $("#todo-panel").classList.remove("todo-clear");
  });
  $("#todoClear").addEventListener("click", () => {
    setTodoBg("transparent");
    $("#todo-panel").classList.add("todo-clear");
  });
  $("#todoGlass").addEventListener("change", (e) => $("#todo-panel").classList.toggle("todo-glass", e.target.checked));

  /* ---------- Init ---------- */
  (function boot(){
    applyGradient();
    restyleClockPanels();
    applyWax();
    document.body.classList.add("todo-on");
    safeBuildClock();
    previewLayout();
    setWaxHeightByProgress(1);
    requestAnimationFrame(() => positionFlame());
    // Seed one empty to‑do
    const li = makeTodoItem("");
    todoList.appendChild(li);
  })();
</script>
</body>
</html>

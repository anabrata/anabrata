<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>World of PDFs • Remove Color • Made by ANABRATA</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --green:#10b981; --blue:#3b82f6; --yellow:#fde047; --pink:#f9a8d4;
    --card:#ffffffee; --text:#0b1020; --muted:#4b5563; --ring:rgba(0,0,0,.12);
    --grad:linear-gradient(135deg,var(--green),var(--blue),var(--yellow));
  }
  body{
    margin:0; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
    background:
      radial-gradient(1200px 800px at 10% 10%, rgba(16,185,129,.22), transparent 60%),
      radial-gradient(1200px 800px at 90% 20%, rgba(59,130,246,.22), transparent 60%),
      radial-gradient(1200px 800px at 50% 100%, rgba(253,224,71,.22), transparent 60%),
      linear-gradient(120deg, #e8fdf6, #eef4ff 40%, #fffbe6 80%, #ffffff);
    background-size:140% 140%; animation:bgShift 18s ease-in-out infinite alternate;
  }
  @keyframes bgShift{0%{background-position:0% 0%,100% 0%,50% 100%,0% 0%}100%{background-position:50% 30%,50% 20%,60% 70%,100% 100%}}
  .wrap{ width:min(980px,94%); margin:0 auto }
  header.hero{ min-height:24vh; display:grid; place-items:center; text-align:center; padding: clamp(1.2rem,5vw,2.2rem) 0 1rem; }
  .welcome{
    font-weight:900; letter-spacing:.05em; line-height:1.1;
    background:linear-gradient(90deg, var(--green), var(--blue), var(--yellow), var(--pink), var(--green));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    background-size:220% 100%; animation:hue 14s linear infinite, fadeInOut 8s ease-in-out infinite;
    font-size: clamp(1.1rem, 4.2vw, 2.2rem);
  }
  @keyframes hue{0%{background-position:0% 50%}100%{background-position:220% 50%}}
  @keyframes fadeInOut{0%{opacity:0}18%{opacity:1}82%{opacity:1}100%{opacity:0}}
  .byline{ margin-top:.5rem; font-weight:800; color:#0b1020; display:inline-block; padding:.35rem .7rem; border-radius:.7rem;
           background:linear-gradient(90deg, rgba(16,185,129,.18), rgba(59,130,246,.18), rgba(253,224,71,.18));
           box-shadow:0 6px 22px rgba(16,185,129,.14), 0 4px 16px rgba(59,130,246,.12) }

  .panel{ background:var(--card); border:1px solid var(--ring); border-radius:14px; padding:1rem; box-shadow:0 10px 28px rgba(0,0,0,.08); margin-top:1rem }
  .row{ display:flex; gap:.9rem; align-items:center; flex-wrap:wrap; justify-content:center }
  .btn{ background:var(--grad); color:#073b2b; border:0; padding:.9rem 1.2rem; border-radius:1rem; font-weight:900; cursor:pointer;
        box-shadow:0 8px 22px rgba(16,185,129,.22), 0 4px 14px rgba(59,130,246,.14); font-size:1.02rem }
  .btn.ghost{ background:linear-gradient(135deg, rgba(16,185,129,.12), rgba(59,130,246,.12)); color:#0b1020; border:1px solid var(--ring) }
  .field{ display:flex; align-items:center; gap:.55rem; background:#f8fafc; border:1px solid #e5e7eb; border-radius:.9rem; padding:.55rem .75rem }
  .muted{ color:#4b5563 }
  progress{ width:100% }
  .tags{ display:flex; flex-wrap:wrap; gap:.35rem; justify-content:center; margin-top:.4rem }
  .tag{ padding:.25rem .55rem; border-radius:.7rem; background:#fff; border:1px solid #e5e7eb; font-size:.9rem }
  .info{ text-align:center; color:#111827; opacity:.9; margin:1.2rem 0 2.2rem }
</style>
</head>
<body>
  <header class="hero">
    <div class="wrap">
      <div class="welcome">WELCOME TO THE WORLD OF PDFs</div>
      <div class="byline">Made by ANABRATA</div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div style="font-weight:900; font-size:1.15rem">Remove a specific color (lossless stream edit)</div>
      <div class="muted" style="margin-top:.15rem">No rasterization. Pages remain vector/text. Rewrites only color‑set commands that match your target color.</div>

      <div class="row" style="margin-top:.8rem">
        <button class="btn" id="pick">Choose PDF</button>
        <button class="btn ghost" id="run" disabled>Remove color → Download</button>
        <a id="download" class="btn ghost" download="color_removed.pdf" href="#" aria-disabled="true">Download</a>
      </div>

      <div class="row" style="margin-top:.8rem">
        <div class="field"><label>Target color</label><input id="hex" type="text" value="#e6e6e6"></div>
        <div class="field"><label>Tolerance (0–255)</label><input id="tol" type="number" min="0" max="40" step="1" value="8"></div>
        <div class="muted">Tip: start with tolerance 8–12. Higher = match more near shades.</div>
      </div>

      <div class="panel">
        <progress id="prog" value="0" max="100" hidden></progress>
        <div id="note" class="muted" style="margin-top:.35rem; min-height:1.2em"></div>
        <div id="tags" class="tags"></div>
      </div>
    </section>

    <section class="panel">
      <div style="font-weight:800; margin-bottom:.4rem">What’s changed</div>
      <div class="muted">
        - Matches and rewrites these operators when they are near your color:<br>
        RGB: “rg / RG”, Gray: “g / G”, CMYK: “k / K”, Generic: “sc / SC” (3‑component).<br>
        - Rewritten to pure white (RGB 1 1 1, Gray 1, CMYK 0 0 0 0). Everything else remains untouched.
      </div>
    </section>

    <div class="info">© <span id="year"></span> Made by ANABRATA</div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

<script>
document.getElementById('year').textContent = new Date().getFullYear();

const pickBtn = document.getElementById('pick');
const runBtn = document.getElementById('run');
const downloadA = document.getElementById('download');
const hexInput = document.getElementById('hex');
const tolInput = document.getElementById('tol');
const note = document.getElementById('note');
const prog = document.getElementById('prog');
const tags = document.getElementById('tags');

const fileIn = document.createElement('input');
fileIn.type = 'file';
fileIn.accept = 'application/pdf';

let pdfBytes = null;

pickBtn.onclick = () => fileIn.click();
fileIn.onchange = async () => {
  if (!fileIn.files || !fileIn.files[0]) return;
  pdfBytes = new Uint8Array(await fileIn.files[0].arrayBuffer());
  runBtn.disabled = false;
  downloadA.removeAttribute('href'); downloadA.setAttribute('aria-disabled','true');
  tags.innerHTML = '';
  note.textContent = `Selected: ${fileIn.files[0].name}`;
};

runBtn.onclick = async () => {
  if (!pdfBytes){ note.textContent = "Choose a PDF first."; return; }
  try{
    const hex = (hexInput.value || '#e6e6e6').trim();
    const RGB = hexToRgb(hex);
    if (!RGB) { note.textContent = "Invalid hex color. Example: #e6e6e6"; return; }
    const tol = Math.max(0, Math.min(255, parseInt(tolInput.value||'8',10)));
    const target = { r: RGB.r/255, g: RGB.g/255, b: RGB.b/255, gray: (RGB.r+RGB.g+RGB.b)/(3*255) };
    const tolF = tol/255;

    prog.hidden = false; prog.value = 8; note.textContent = "Loading PDF…";

    const { PDFDocument, PDFName, PDFArray, PDFDict, PDFRawStream } = PDFLib;
    const doc = await PDFDocument.load(pdfBytes, { updateMetadata:false, ignoreEncryption:false });
    const ctx = doc.context;

    let totalStreams=0, editedStreams=0, rgbHits=0, grayHits=0, cmykHits=0, scHits=0;

    for (const page of doc.getPages()){
      const cRef = page.node.get(PDFName.of('Contents'));
      if (!cRef) continue;
      const arr = (cRef instanceof PDFArray) ? cRef : (()=>{const a=PDFArray.withContext(ctx); a.push(cRef); return a;})();
      const outArr = PDFArray.withContext(ctx);

      for (let i=0;i<arr.size();i++){
        totalStreams++;
        const sref = arr.get(i);
        const stream = ctx.lookup(sref, PDFRawStream);
        const filter = stream.dict.get(PDFName.of('Filter'));
        const fName = String(filter||'');
        const bytes = (fName === '/FlateDecode') ? pako.inflate(stream.getContents()) : stream.getContents();
        let src = new TextDecoder('latin1').decode(bytes);

        const before = src;
        const res = rewriteColors(src, target, tolF);
        src = res.text;
        rgbHits += res.rgb; grayHits += res.gray; cmykHits += res.cmyk; scHits += res.sc;

        if (src !== before) editedStreams++;

        let outBytes = new TextEncoder().encode(src);
        let outFilter = filter;
        if (fName === '/FlateDecode'){
          outBytes = pako.deflate(outBytes);
          outFilter = PDFName.of('FlateDecode');
        }

        const newDict = stream.dict.clone(ctx);
        newDict.set(PDFName.of('Length'), ctx.obj(outBytes.length));
        if (outFilter) newDict.set(PDFName.of('Filter'), outFilter); else newDict.delete(PDFName.of('Filter'));
        const newStream = ctx.register(new PDFRawStream(newDict, outBytes));
        outArr.push(newStream);
      }
      page.node.set(PDFName.of('Contents'), outArr);
    }

    const out = await doc.save({ useObjectStreams:true, addDefaultPage:false, updateFieldAppearances:false });
    const blob = new Blob([out], { type:'application/pdf' });
    const url = URL.createObjectURL(blob);
    downloadA.href = url;
    downloadA.setAttribute('aria-disabled','false');

    tags.innerHTML = '';
    addTag(`streams ${editedStreams}/${totalStreams} edited`);
    addTag(`RGB hits: ${rgbHits}`);
    addTag(`Gray hits: ${grayHits}`);
    addTag(`CMYK hits: ${cmykHits}`);
    addTag(`SC hits: ${scHits}`);

    prog.value = 100; setTimeout(()=>prog.hidden=true, 300);
    note.textContent = "Done. Download your color‑cleaned PDF.";
  } catch(e){
    console.error(e);
    prog.hidden = true;
    note.textContent = "Failed: " + (e?.message || e);
  }
};

/* ---------- Color rewrite logic ---------- */
const NUM = '([+\\-]?(?:\\d*\\.\\d+|\\d+)(?:[Ee][+\\-]?\\d+)?)';
const WS  = '\\s+';

function rewriteColors(text, tgt, tol){
  let rgb=0, gray=0, cmyk=0, sc=0;

  // RGB: r g b (rg|RG)
  const reRGB = new RegExp(`${NUM}${WS}${NUM}${WS}${NUM}${WS}(rg|RG)\\b`, 'g');
  text = text.replace(reRGB, (m, r,g,b, op) => {
    const R = parseFloat(r), G = parseFloat(g), B = parseFloat(b);
    if (isCloseRGB(R,G,B,tgt, tol)) { rgb++; return `1 1 1 ${op}`; }
    return m;
  });

  // Gray: g|G (single)
  const reGray = new RegExp(`${NUM}${WS}(g|G)\\b`, 'g');
  text = text.replace(reGray, (m, v, op) => {
    const V = parseFloat(v);
    if (Math.abs(V - tgt.gray) <= tol) { gray++; return `1 ${op}`; }
    return m;
  });

  // CMYK: c m y k (k|K) — convert to RGB and compare
  const reCMYK = new RegExp(`${NUM}${WS}${NUM}${WS}${NUM}${WS}${NUM}${WS}(k|K)\\b`, 'g');
  text = text.replace(reCMYK, (m, c,mv,y,k, op) => {
    const C=parseFloat(c), M=parseFloat(mv), Y=parseFloat(y), K=parseFloat(k);
    const R = (1 - Math.min(1, C + K));
    const G = (1 - Math.min(1, M + K));
    const B = (1 - Math.min(1, Y + K));
    if (isCloseRGB(R,G,B,tgt, tol)) { cmyk++; return `0 0 0 0 ${op}`; }
    return m;
  });

  // Generic DeviceRGB-like sc/SC (3 operands)
  const reSC = new RegExp(`${NUM}${WS}${NUM}${WS}${NUM}${WS}(sc|SC)\\b`, 'g');
  text = text.replace(reSC, (m, r,g,b, op) => {
    const R = parseFloat(r), G = parseFloat(g), B = parseFloat(b);
    if (isCloseRGB(R,G,B,tgt, tol)) { sc++; return `1 1 1 ${op}`; }
    return m;
  });

  return { text, rgb, gray, cmyk, sc };
}

function isCloseRGB(R,G,B, tgt, tol){
  // R,G,B,tgt.* are 0..1; compare Euclidean distance
  const dr=R-tgt.r, dg=G-tgt.g, db=B-tgt.b;
  const dist = Math.sqrt(dr*dr + dg*dg + db*db);
  return dist <= Math.sqrt(3)*tol; // scale tol across 3 channels
}

/* ---------- Utils ---------- */
function hexToRgb(hex){
  const m = /^#?([a-f0-9]{6})$/i.exec(hex);
  if (!m) return null;
  const n = parseInt(m[1],16);
  return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
}
function addTag(text){ const s=document.createElement('span'); s.className='tag'; s.textContent=text; tags.appendChild(s); }
</script>
</body>
</html>

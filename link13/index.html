<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Candle Timer — Vision 2.3.1</title>
<style>
  :root{
    /* Flip sizes */
    --digit-w: 120px;
    --digit-h: 170px;
    --digit-radius: 16px;
    --split-line: rgba(0,0,0,0.08);

    /* Background gradient */
    --bg-angle: 135deg;
    --bg-c1: #3a1c71;
    --bg-c2: #d76d77;
    --bg-c3: #ffaf7b;

    /* Default flip clock colors (requested) */
    --clock-c1: #ffffff;    /* white card top-left */
    --clock-c2: #ffffff;    /* white card center */
    --clock-c3: #ffffff;    /* white card bottom-right */
    --clock-text: #000000;  /* black numbers */
    --colon-color: #ffffff; /* white colon/dots */

    /* Buttons */
    --btn-font: "Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    --btn-grad: linear-gradient(135deg,#ffd166,#ff9a00);
    --btn-grad-hover: linear-gradient(135deg,#ffe08a,#ffb347);

    /* Candle */
    --wax: #f2e4c7;
    --wick: #1b1b1b;

    /* Layout tweak */
    --candle-offset: 18px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; display:flex; flex-direction:column; color:#111;
    font-family:"Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background-image: linear-gradient(var(--bg-angle), var(--bg-c1), var(--bg-c2), var(--bg-c3));
    background-attachment: fixed; background-size: cover;
  }

  /* Credit on left */
  .brand{ position:fixed; left:12px; top:10px; z-index:40; color:#fff; font-weight:700; font-size:13px; text-shadow:0 1px 2px rgba(0,0,0,.35); user-select:none; }

  #exitFs{ position:fixed; right:8px; top:6px; z-index:70; width:24px; height:24px; line-height:24px; text-align:center; font-weight:900; color:#fff; background:rgba(0,0,0,.25); border-radius:50%; cursor:pointer; opacity:.35; display:none; }
  #exitFs:hover{ opacity:.65 }

  .main{ flex:1; display:flex; align-items:center; justify-content:space-between; gap:min(6vw,56px); padding:22px min(5vw,48px); }

  /* Flip clock */
  #timer-container{ flex:1; display:flex; align-items:center; justify-content:flex-start; min-width:340px; gap:12px; }
  #timer{ display:flex; align-items:center; gap:12px; user-select:none; }
  #simpleTimer{ display:none; font-weight:900; letter-spacing:.5px; color:var(--clock-text); text-shadow:0 6px 24px rgba(0,0,0,.25); font-size:min(12vw, 120px); }

  .digit{
    position:relative; width:var(--digit-w); height:var(--digit-h); perspective:1200px;
    border-radius:var(--digit-radius); overflow:hidden;
    background: linear-gradient(145deg,var(--clock-c1),var(--clock-c2),var(--clock-c3));
    box-shadow: inset 0 -1px 0 rgba(0,0,0,.05), inset 0 1px 0 rgba(0,0,0,.12);
  }
  .digit .top,.digit .bottom{ position:absolute; left:0; right:0; height:50%; overflow:hidden; backface-visibility:hidden; -webkit-backface-visibility:hidden; }
  .digit .top{ top:0; border-bottom:1px solid var(--split-line); }
  .digit .bottom{ bottom:0; border-top:1px solid var(--split-line); }

  .value{
    position:absolute; left:0; right:0; height:var(--digit-h);
    display:flex; align-items:center; justify-content:center;
    font-weight:900; color:var(--clock-text);
    font-size: calc(var(--digit-h)*.70); line-height:var(--digit-h);
  }
  /* precise half clipping */
  .top .value,.top-flip .value{ clip-path: inset(0 0 50% 0); transform: translateY(0); }
  .bottom .value,.bottom-flip .value{ clip-path: inset(50% 0 0 0); transform: translateY(-50%); }

  .top-flip,.bottom-flip{ position:absolute; left:0; right:0; height:50%; overflow:hidden; backface-visibility:hidden; -webkit-backface-visibility:hidden; background:inherit; }
  .top-flip{ top:0; transform-origin:bottom; border-bottom:1px solid var(--split-line); animation: topFlip .26s ease-in forwards; }
  .bottom-flip{ bottom:0; transform-origin:top; border-top:1px solid var(--split-line); animation: bottomFlip .26s ease-out forwards; }
  @keyframes topFlip{ 0%{transform:rotateX(0)} 100%{transform:rotateX(-90deg)} }
  @keyframes bottomFlip{ 0%{transform:rotateX(90deg)} 100%{transform:rotateX(0)} }

  .colon{ display:flex; align-items:center; justify-content:center; width:calc(var(--digit-w)*.33); height:var(--digit-h); font-size:calc(var(--digit-h)*.6); font-weight:900; color:var(--colon-color); text-shadow:0 2px 6px rgba(0,0,0,.25); }

  /* Candle (down a bit) */
  #candle-area{ flex:1; display:flex; align-items:flex-end; justify-content:flex-end; min-width:340px; height:max(380px,42vh); position:relative; transform: translateY(var(--candle-offset)); }
  .candle-clip{ position:relative; width:180px; height:380px; overflow:hidden; display:flex; align-items:flex-end; justify-content:center; }
  .candle-wrap{ position:absolute; inset:auto 0 0 0; margin:auto; width:180px; height:380px; display:flex; align-items:flex-end; justify-content:center; transition: transform .5s ease, opacity .5s ease; }
  .candle-wrap.vanish{ transform: scale(.85) translateY(12px); opacity: 0; pointer-events:none; }

  .wax{
    position:absolute; bottom:0; width:150px; height:100%; z-index:1;
    border-radius:22px;
    background:
      radial-gradient(120px 26px at 75px 6px, rgba(255,255,255,.70), transparent 62%),
      linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,0) 24%),
      linear-gradient(180deg,#ffffff33,#00000022 40%,#00000028 100%),
      linear-gradient(180deg,var(--wax), #e6d9bb);
    transition: height .22s linear;
  }
  .waxTop{
    position:absolute; top:-22px; left:50%; transform:translateX(-50%); width:150px; height:44px; pointer-events:none; z-index:3;
    background:
      conic-gradient(from 0deg at 50% 50%, rgba(255,255,255,.33) 0deg, rgba(255,255,255,.10) 70deg, rgba(0,0,0,.08) 180deg, rgba(255,255,255,.20) 300deg, rgba(255,255,255,.33) 360deg),
      radial-gradient(65% 55% at 50% 62%, rgba(255,255,255,.52), rgba(255,255,255,.12) 60%, rgba(0,0,0,.10) 100%);
    border-radius:50%/62% 62% 38% 38%;
  }
  .wax:after{
    content:""; position:absolute; top:30px; left:24px; width:12px; height:64px; border-radius:10px;
    background: linear-gradient(180deg,#fff6,#0000 60%), var(--wax);
    box-shadow: 44px 8px 0 -3px var(--wax), 44px 8px 0 -3px #fff6, 92px 12px 0 -6px var(--wax), 92px 12px 0 -6px #fff6; opacity:.85;
  }
  .wick{ position:absolute; width:6px; height:30px; background:linear-gradient(180deg,#444,var(--wick)); border-radius:4px; top:-12px; left:50%; transform:translateX(-50%); z-index:4; }

  .flame{
    position:absolute; width:52px; height:110px; z-index:6;
    background:
      radial-gradient(ellipse at 50% 22%, #fff7c0 0%, #ffe08a 38%, #ffb347 58%, #ff7a00 78%, transparent 80%),
      radial-gradient(ellipse at 50% 45%, #ffffff 0%, transparent 65%);
    border-radius:50% 50% 38% 38%;
    box-shadow:0 0 18px 6px rgba(255,170,40,.55), 0 0 36px 14px rgba(255,140,0,.40), 0 -20px 28px rgba(255,220,170,.40);
    animation: flickerSoft .6s ease-in-out infinite;
    transition: opacity .35s ease;
    pointer-events:none;
  }
  @keyframes flickerSoft{
    0%{ transform:scale(1) rotate(-0.8deg); opacity:.95 }
    50%{ transform:scale(1.06) rotate(0.6deg); opacity:.82 }
    100%{ transform:scale(1) rotate(-0.8deg); opacity:.95 }
  }
  .flame.off{ opacity:0 !important; animation-play-state: paused !important; }

  .stub{ display:none; position:absolute; bottom:0; width:150px; height:58px; background:linear-gradient(180deg,#9a9a9a,#6f6f6f); border-radius:0 0 22px 22px; z-index:1; }
  .smoke{ position:absolute; width:10px; height:10px; left:0; top:0; border-radius:50%; background:radial-gradient(#bbb, transparent 64%); opacity:0; pointer-events:none; z-index:7; }
  .smoke.show{ animation:puff 1.4s ease-out forwards; }
  @keyframes puff{ 0%{ transform:translate(0,0) scale(1); opacity:.8; filter:blur(.4px) } 100%{ transform:translate(0,-120px) scale(2.1); opacity:0; filter:blur(3px) } }

  /* Controls */
  #controls{ position:relative; display:grid; grid-auto-flow:column; grid-auto-columns:minmax(240px,1fr); gap:14px; padding:16px; background:rgba(0,0,0,.22); backdrop-filter:blur(8px); scroll-snap-type:x mandatory; overflow-x:auto; border-top-left-radius:16px; border-top-right-radius:16px; z-index:10; }
  .card{ position:relative; scroll-snap-align:start; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; min-height:84px; display:flex; flex-direction:column; gap:8px; }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  label{ font-size:12px; color:#fff; opacity:.95 }
  input[type="number"],input[type="color"],select{ width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.35); color:#fff; outline:none; }
  input[type="checkbox"]{ transform:scale(1.2) }

  .btn{ position:relative; padding:12px 18px; border-radius:12px; border:none; font-weight:800; cursor:pointer; font-family: var(--btn-font); background:var(--btn-grad); color:#1b1b1b; box-shadow:0 6px 16px rgba(0,0,0,.18); transition:transform .12s, box-shadow .2s, background .2s; }
  .btn:hover{ background:var(--btn-grad-hover); box-shadow:0 10px 24px rgba(0,0,0,.28); }
  .btn:active{ transform: translateY(1px) scale(.99); }
  .btn.alt{ background:linear-gradient(135deg,#a5b4fc,#6366f1); color:#0d0d15; }
  .btn.warn{ background:linear-gradient(135deg,#fca5a5,#ef4444); color:#0d0d15; }

  /* Real-time overlay */
  #rtcOverlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:90; }
  #rtcOverlay.show{ display:flex; }
  #rtcTimer{ display:flex; align-items:center; gap:12px; }
  #simpleRTC{ display:none; font-weight:900; letter-spacing:.5px; color:var(--clock-text); text-shadow:0 6px 24px rgba(0,0,0,.25); font-size:min(12vw, 120px); }
  #rtcBack{ position:fixed; top:8px; left:10px; opacity:.45; background:rgba(0,0,0,.25); color:#fff; border-radius:10px; padding:6px 10px; font-weight:800; border:none; cursor:pointer; z-index:95; }
  #rtcBack:hover{ opacity:.75 }
  .rtc-only .brand, .rtc-only #controls, .rtc-only #main, .rtc-only #exitFs { display:none !important; }

  /* Congrats overlay + balloons */
  #congrats{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; flex-direction:column; background:rgba(0,0,0,.35); z-index:95; backdrop-filter:blur(2px); }
  #congrats.show{ display:flex; }
  .cg-card{ background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2); padding:22px 26px; border-radius:16px; text-align:center; color:#fff; box-shadow:0 14px 40px rgba(0,0,0,.4); }
  .cg-title{ font-size:28px; font-weight:900; margin-bottom:6px; }
  .cg-sub{ font-size:14px; opacity:.95; margin-bottom:12px; }
  .balloon{ position:fixed; bottom:-120px; width:28px; height:36px; border-radius:50% 50% 45% 45%; background: radial-gradient(circle at 30% 30%, #ffffff88, #ffffff00 40%), var(--bcol, #f87171); box-shadow: inset -6px -12px 16px rgba(0,0,0,.12); z-index:96; animation: floatUp var(--dur, 6s) linear forwards; }
  .balloon:after{ content:""; position:absolute; bottom:-16px; left:50%; width:2px; height:18px; background:#fff8; transform:translateX(-50%); }
  @keyframes floatUp{ 0%{ transform: translateY(0) translateX(0) scale(1); opacity:.95 } 100%{ transform: translateY(-120vh) translateX(var(--drift,40px)) scale(1.05); opacity:1 } }

  /* Fullscreen: only timer + candle visible */
  .fullscreen-on .brand,
  .fullscreen-on #controls,
  .fullscreen-on #rtcOverlay,
  .fullscreen-on #congrats,
  .fullscreen-on #exitFs{ display:none !important }

  /* 3s pre-start overlay (fade animation) */
  #preOverlay{
    position:fixed; inset:0; z-index:100;
    display:none; align-items:center; justify-content:center;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(2px);
  }
  #preOverlay:not([hidden]){ display:flex }
  #preNum{
    font-family:"Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, Arial;
    font-size:min(22vw, 220px); font-weight:900; color:#fff;
    text-shadow:0 10px 40px rgba(0,0,0,.6);
    opacity:0; transform:scale(.9);
  }
  /* fading step per number */
  .step{ animation: fadeStep 1s ease both }
  @keyframes fadeStep{
    0%  { opacity:0; transform:scale(.9) }
    20% { opacity:1; transform:scale(1) }
    80% { opacity:1; transform:scale(1) }
    100%{ opacity:0; transform:scale(1.06) }
  }

  /* Hide everything but overlay while pre-start is active */
  .pre-on .brand,
  .pre-on #controls,
  .pre-on #exitFs,
  .pre-on #rtcOverlay,
  .pre-on #congrats{ display:none !important }

  /* Utility: temporarily disable transitions for snap reset */
  .no-transitions{ transition: none !important; } /* turn off all transitions during reset snap */

  @media (max-width:980px){ :root{ --digit-w:100px; --digit-h:140px; } }
  @media (max-width:720px){ :root{ --digit-w:86px; --digit-h:120px; } }
</style>
</head>
<body>
  <div class="brand">MADE BY ANABRATA</div>
  <div id="exitFs" title="Exit fullscreen">×</div>

  <div class="main" id="main">
    <!-- Timer -->
    <section id="timer-container" aria-label="Timer">
      <div id="timer"></div>
      <div id="simpleTimer">00:00</div>
    </section>

    <!-- Candle -->
    <section id="candle-area" aria-label="Candle">
      <div class="candle-clip">
        <div class="candle-wrap" id="candleWrap">
          <div class="wax" id="wax">
            <div class="waxTop"></div>
            <div class="wick" id="wick"></div>
          </div>
          <div class="stub" id="stub"></div>
        </div>
      </div>
      <div class="flame" id="flame"></div>
      <div class="smoke" id="smoke"></div>
    </section>
  </div>

  <!-- Real-time only clock -->
  <div id="rtcOverlay">
    <button id="rtcBack" title="Back">Back</button>
    <div id="rtcTimer"></div>
    <div id="simpleRTC">00:00:00</div>
  </div>

  <!-- Congrats -->
  <div id="congrats">
    <div class="cg-card">
      <div class="cg-title">Congratulations!</div>
      <div class="cg-sub">The timer is complete. Great focus!</div>
      <button id="cgClose" class="btn alt">Close</button>
    </div>
  </div>

  <!-- 3-second pre-start overlay -->
  <div id="preOverlay" hidden>
    <div id="preNum">3</div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <div class="card">
      <label class="small" style="color:#fff">Timer</label>
      <div class="row">
        <div style="flex:1"><label for="hoursInput">Hours</label><input id="hoursInput" type="number" min="0" value="0"></div>
        <div style="flex:1"><label for="minInput">Minutes</label><input id="minInput" type="number" min="0" value="1"></div>
        <div style="flex:1"><label for="secInput">Seconds</label><input id="secInput" type="number" min="0" max="59" value="0"></div>
      </div>
      <div class="row">
        <label><input type="checkbox" id="showHours"> Show hours</label>
        <label><input type="checkbox" id="showSeconds" checked> Show seconds</label>
        <label><input type="checkbox" id="useFlip" checked> Use flip style</label>
        <label><input type="checkbox" id="rtcMode"> Real‑time only clock</label>
      </div>
      <div class="row">
        <button id="primaryBtn" class="btn">Start</button>
        <button id="resetBtn" class="btn alt">Reset</button>
        <button id="fsBtn" class="btn warn">Fullscreen</button>
      </div>
    </div>

    <div class="card">
      <label class="small" style="color:#fff">Background gradient</label>
      <div class="row">
        <div style="flex:1"><label for="bgAngle">Angle</label><input id="bgAngle" type="number" min="0" max="360" value="135"></div>
        <div style="flex:1"><label for="bgC1">Color 1</label><input id="bgC1" type="color" value="#3a1c71"></div>
        <div style="flex:1"><label for="bgC2">Color 2</label><input id="bgC2" type="color" value="#d76d77"></div>
        <div style="flex:1"><label for="bgC3">Color 3</label><input id="bgC3" type="color" value="#ffaf7b"></div>
      </div>
    </div>

    <div class="card">
      <label class="small" style="color:#fff">Flip clock colors</label>
      <div class="row">
        <div style="flex:1"><label for="clockC1">Panel 1</label><input id="clockC1" type="color" value="#ffffff"></div>
        <div style="flex:1"><label for="clockC2">Panel 2</label><input id="clockC2" type="color" value="#ffffff"></div>
        <div style="flex:1"><label for="clockC3">Panel 3</label><input id="clockC3" type="color" value="#ffffff"></div>
      </div>
      <div class="row">
        <div style="flex:1"><label for="textColor">Digit color</label><input id="textColor" type="color" value="#000000"></div>
        <div style="flex:1"><label for="colonColor">Colon color</label><input id="colonColor" type="color" value="#ffffff"></div>
      </div>
    </div>

    <div class="card">
      <label class="small" style="color:#fff">Candle</label>
      <div class="row">
        <div style="flex:1"><label for="waxColor">Wax color</label><input id="waxColor" type="color" value="#f2e4c7"></div>
      </div>
    </div>
  </div>

<script>
  const $ = s => document.querySelector(s);

  /* Background */
  const gradientStr = (a,c1,c2,c3)=>`linear-gradient(${a}deg, ${c1}, ${c2}, ${c3})`;
  function applyGradient(){
    const ang = parseInt($('#bgAngle').value||'135',10);
    document.body.style.backgroundImage = gradientStr(ang,$('#bgC1').value,$('#bgC2').value,$('#bgC3').value);
  }

  /* Flip clock core */
  function createDigit(initial="0"){
    const d = document.createElement('div'); d.className='digit'; d.dataset.value=initial;
    const top = document.createElement('div'); top.className='top'; const t=document.createElement('span'); t.className='value'; t.textContent=initial; top.appendChild(t);
    const bottom = document.createElement('div'); bottom.className='bottom'; const b=document.createElement('span'); b.className='value'; b.textContent=initial; bottom.appendChild(b);
    d.appendChild(top); d.appendChild(bottom); return d;
  }
  function flipTo(digitEl,newVal){
    const cur=digitEl.dataset.value||"0"; if (cur===newVal) return;
    const topVal=digitEl.querySelector('.top .value'); const botVal=digitEl.querySelector('.bottom .value');
    const topFlip=document.createElement('div'); topFlip.className='top-flip'; const t=document.createElement('span'); t.className='value'; t.textContent=cur; topFlip.appendChild(t);
    topVal.textContent=cur; botVal.textContent=cur; digitEl.appendChild(topFlip);
    topFlip.addEventListener('animationend', ()=>{
      topVal.textContent=newVal; topFlip.remove();
      const bottomFlip=document.createElement('div'); bottomFlip.className='bottom-flip'; const b=document.createElement('span'); b.className='value'; b.textContent=newVal; bottomFlip.appendChild(b);
      digitEl.appendChild(bottomFlip);
      bottomFlip.addEventListener('animationend', ()=>{ botVal.textContent=newVal; digitEl.dataset.value=newVal; bottomFlip.remove(); });
    });
  }
  function buildFlip(container, showH=true, showS=true){
    container.innerHTML=''; const digits=[]; const addDigit=()=>{ const d=createDigit("0"); container.appendChild(d); digits.push(d); }; const addColon=()=>{ const c=document.createElement('div'); c.className='colon'; c.textContent=':'; container.appendChild(c); };
    if (showH){ addDigit(); addDigit(); addColon(); } addDigit(); addDigit(); if (showS){ addColon(); addDigit(); addDigit(); } return digits;
  }
  function timeArray(sec, showH, showS){
    let h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; h=Math.min(h,99);
    const arr=[]; if (showH) arr.push(...String(h).padStart(2,'0')); arr.push(...String(m).padStart(2,'0')); if (showS) arr.push(...String(s).padStart(2,'0')); return arr;
  }
  function tickFlip(digits, sec, showH, showS){
    const arr=timeArray(sec,showH,showS); digits.forEach((d,i)=> flipTo(d, arr[i] || '0'));
  }

  /* Countdown */
  const timerFlip = $('#timer'), timerSimple = $('#simpleTimer'), primaryBtn = $('#primaryBtn');
  let flipDigits=[], showH=false, showS=true, useFlip=true;

  let totalSec=0, endAtMs=0, rafId=null, lastWhole=-1, running=false, paused=false, pauseRemainMs=0;

  function refreshMode(){
    useFlip = $('#useFlip').checked;
    timerFlip.style.display = useFlip ? 'flex' : 'none';
    timerSimple.style.display = useFlip ? 'none' : 'block';
  }

  function renderSimple(sec){
    const str = showH ? `${String(Math.floor(sec/3600)).padStart(2,'0')}:${String(Math.floor((sec%3600)/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}` : `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;
    timerSimple.textContent = str;
  }

  function startCountdown(){
    showH = $('#showHours').checked; showS = $('#showSeconds').checked;
    const h=+$('#hoursInput').value||0, m=+$('#minInput').value||0, s=Math.max(0,Math.min(59,+$('#secInput').value||0));
    totalSec=h*3600+m*60+s;

    /* Ensure candle is visible when (re)starting */
    candleWrap.classList.remove('vanish');
    candleWrap.style.opacity = '';
    candleWrap.style.transform = '';
    stubEl.style.display = 'none';
    flameEl.classList.remove('off');
    setWaxHeightByProgress(1);
    positionFlame();

    if (useFlip){
      flipDigits = buildFlip(timerFlip, showH, showS);
      tickFlip(flipDigits,totalSec,showH,showS);
    }else{
      renderSimple(totalSec);
    }

    cancelAnimationFrame(rafId); paused=false; running=false;
    if (totalSec<=0){ finishNow(); return; }
    endAtMs = performance.now()+totalSec*1000; lastWhole=Math.ceil(totalSec); running=true;
    primaryBtn.textContent='Stop';
    rafId = requestAnimationFrame(loop);
  }

  function loop(now){
    if (!running) return;
    const remainMs=Math.max(0,endAtMs-now), secWhole=Math.floor(remainMs/1000);
    if (secWhole!==lastWhole){
      if (useFlip) tickFlip(flipDigits,secWhole,showH,showS); else renderSimple(secWhole);
      lastWhole=secWhole;
    }
    const p = totalSec>0 ? remainMs/(totalSec*1000) : 0;
    setWaxHeightByProgress(p); positionFlame();

    if (remainMs<=0){ finishNow(); return; }
    rafId=requestAnimationFrame(loop);
  }

  /* 3‑second fade pre‑start */
  let preRAF = null;
  function startWithFadeCountdown(){
    if (running || paused) return;
    const overlay = $('#preOverlay');
    const label = $('#preNum');
    document.body.classList.add('pre-on');
    overlay.hidden = false;

    const D = 3000; // 3 seconds
    const endAt = performance.now() + D;

    function step(ts){
      const remain = Math.max(0, endAt - ts);
      const n = Math.ceil(remain/1000);
      const text = n > 0 ? String(n) : 'Go';
      if (label.textContent !== text){
        label.textContent = text;
        label.classList.remove('step'); void label.offsetWidth; label.classList.add('step'); // restart fade
      }
      if (remain <= 0){
        overlay.hidden = true;
        document.body.classList.remove('pre-on');
        startCountdown();
        return;
      }
      preRAF = requestAnimationFrame(step);
    }
    preRAF = requestAnimationFrame(step);
  }

  function togglePrimary(){
    if (!running && !paused){
      startWithFadeCountdown(); // fade-in pre-start
      return;
    }
    if (running){
      cancelAnimationFrame(rafId);
      pauseRemainMs = Math.max(0, endAtMs - performance.now());
      paused=true; running=false;
      primaryBtn.textContent='Resume';
      return;
    }
    if (paused){
      endAtMs = performance.now()+pauseRemainMs;
      lastWhole = Math.floor(pauseRemainMs/1000);
      paused=false; running=true;
      primaryBtn.textContent='Stop';
      rafId=requestAnimationFrame(loop);
    }
  }

  /* Snap-reset candle + flame (fix) */
  function snapResetCandle(){
    // Temporarily disable transitions so geometry snaps immediately
    candleWrap.classList.add('no-transitions');  // cancel transform/opacity transition
    waxEl.classList.add('no-transitions');       // cancel height transition

    // Restore base visual state
    candleWrap.classList.remove('vanish');
    candleWrap.style.opacity = '';
    candleWrap.style.transform = '';
    stubEl.style.display = 'none';
    flameEl.classList.remove('off');
    smokeEl.classList.remove('show');

    // Reset wax height instantly
    setWaxHeightByProgress(1);

    // Force layout so styles and sizes apply before positioning
    void candleWrap.offsetHeight; // reflow

    // Place flame at the correct wick position this same frame
    positionFlame();

    // Re-enable transitions on the next frame
    requestAnimationFrame(()=>{ // after next paint
      candleWrap.classList.remove('no-transitions');
      waxEl.classList.remove('no-transitions');
    });
  }

  function resetCountdown(){
    cancelAnimationFrame(rafId); running=false; paused=false;
    if (preRAF){ cancelAnimationFrame(preRAF); preRAF=null; $('#preOverlay').hidden=true; document.body.classList.remove('pre-on'); }
    primaryBtn.textContent='Start';
    // rebuild display per current toggles
    showH = $('#showHours').checked; showS = $('#showSeconds').checked;
    if (useFlip){
      flipDigits = buildFlip(timerFlip, showH, showS);
      tickFlip(flipDigits, 0, showH, showS);
    }else{
      renderSimple(0);
    }
    // Snap both candle and flame back to original place (fix)
    snapResetCandle();
    hideCongrats();
  }

  /* Finish behavior */
  function finishNow(){
    cancelAnimationFrame(rafId); running=false; paused=false;
    extinguish();
    candleWrap.classList.add('vanish');
    showCongrats();
    primaryBtn.textContent='Start';
  }

  /* Candle coupling */
  const area = $('#candle-area'), waxEl=$('#wax'), wickEl=$('#wick'), flameEl=$('#flame'), stubEl=$('#stub'), smokeEl=$('#smoke'), candleWrap=$('#candleWrap');
  const baseWaxHeight=380, minStub=58;

  function positionFlame(){
    const w=wickEl.getBoundingClientRect(), a=area.getBoundingClientRect();
    const x=w.left+w.width/2-a.left-flameEl.offsetWidth/2, y=w.top-a.top-flameEl.offsetHeight+20;
    flameEl.style.left=`${x}px`; flameEl.style.top=`${y}px`;
    smokeEl.style.left=`${x + flameEl.offsetWidth/2 - 5}px`; smokeEl.style.top=`${y - 2}px`;
  }
  function setWaxHeightByProgress(progress){
    const usable=baseWaxHeight-minStub, h=minStub+Math.max(0, usable*progress);
    waxEl.style.height=`${h}px`;
  }
  function extinguish(){
    flameEl.classList.add('off');
    smokeEl.classList.remove('show'); void smokeEl.offsetWidth; smokeEl.classList.add('show');
    stubEl.style.display='block';
  }
  function relight(){
    stubEl.style.display='none';
    flameEl.classList.remove('off');
  }

  /* Congrats */
  const congrats = $('#congrats');
  $('#cgClose').addEventListener('click', hideCongrats);
  function showCongrats(){
    congrats.classList.add('show');
    launchBalloons(16);
  }
  function hideCongrats(){ congrats.classList.remove('show'); }
  function launchBalloons(count=16){
    const colors = ['#f87171','#60a5fa','#34d399','#fbbf24','#a78bfa','#fb7185','#22d3ee'];
    for (let i=0;i<count;i++){
      const b=document.createElement('div'); b.className='balloon';
      b.style.left=`calc(${Math.random()*100}vw)`;
      b.style.setProperty('--bcol', colors[Math.floor(Math.random()*colors.length)]);
      b.style.setProperty('--dur', (5 + Math.random()*4).toFixed(2) + 's');
      b.style.setProperty('--drift', ((Math.random()*120 - 60)|0) + 'px');
      document.body.appendChild(b);
      b.addEventListener('animationend', ()=> b.remove());
    }
  }

  /* Fullscreen */
  async function goFullscreen(){
    try{
      if (!document.fullscreenElement){ await document.documentElement.requestFullscreen(); }
      document.body.classList.add('fullscreen-on'); // hide everything except timer + candle
    }catch(e){}
  }
  function exitFullscreen(){
    document.exitFullscreen?.();
    document.body.classList.remove('fullscreen-on');
  }
  $('#fsBtn').addEventListener('click', goFullscreen);
  $('#exitFs').addEventListener('click', exitFullscreen);
  document.addEventListener('fullscreenchange', ()=>{
    if (!document.fullscreenElement){ document.body.classList.remove('fullscreen-on'); }
  });

  /* Real-time overlay (uses current flip/simple setting) */
  const rtcOverlay=$('#rtcOverlay'), rtcFlipContainer=$('#rtcTimer'), rtcSimple=$('#simpleRTC'), rtcBack=$('#rtcBack');
  let rtcDigits=[], rtcOn=false, rtcId=null, rtcLastSec=-1;

  function refreshRTCMode(){
    const useFlip=$('#useFlip').checked;
    rtcFlipContainer.style.display = useFlip ? 'flex' : 'none';
    rtcSimple.style.display = useFlip ? 'none' : 'block';
  }
  function openRTC(){
    document.body.classList.add('rtc-only'); rtcOverlay.classList.add('show');
    cancelAnimationFrame(rafId); running=false; paused=false; primaryBtn.textContent='Start';
    rtcOn=true; rtcLastSec=-1;
    if ($('#useFlip').checked){ rtcDigits = buildFlip(rtcFlipContainer, true, true); }
    drawRTC();
  }
  function closeRTC(){
    document.body.classList.remove('rtc-only'); rtcOverlay.classList.remove('show');
    rtcOn=false; cancelAnimationFrame(rtcId);
    $('#rtcMode').checked = false; // untick when coming back
  }
  function drawRTC(){
    if (!rtcOn) return;
    const secOfDay = Math.floor(Date.now()/1000)%86400; // 1Hz updates
    if (secOfDay !== rtcLastSec){
      if ($('#useFlip').checked){ tickFlip(rtcDigits, secOfDay, true, true); }
      else{ rtcSimple.textContent = new Date().toLocaleTimeString(); }
      rtcLastSec = secOfDay;
    }
    rtcId = requestAnimationFrame(drawRTC);
  }
  rtcBack.addEventListener('click', closeRTC);

  /* Colors & bindings */
  function restyleClockPanels(){
    document.documentElement.style.setProperty('--clock-c1',$('#clockC1').value);
    document.documentElement.style.setProperty('--clock-c2',$('#clockC2').value);
    document.documentElement.style.setProperty('--clock-c3',$('#clockC3').value);
    document.documentElement.style.setProperty('--clock-text',$('#textColor').value);
    document.documentElement.style.setProperty('--colon-color',$('#colonColor').value);
  }
  function applyWax(){ document.documentElement.style.setProperty('--wax',$('#waxColor').value); }

  /* Preview when toggling hours/seconds so Show hours works immediately */
  function previewLayout(){
    showH = $('#showHours').checked; showS = $('#showSeconds').checked;
    useFlip = $('#useFlip').checked;
    if (useFlip){
      flipDigits = buildFlip(timerFlip, showH, showS);
      tickFlip(flipDigits, 0, showH, showS);
    }else{
      renderSimple(0);
    }
  }

  // UI events
  $('#primaryBtn').addEventListener('click', togglePrimary);
  $('#resetBtn').addEventListener('click', resetCountdown);
  $('#useFlip').addEventListener('change', ()=>{ refreshMode(); refreshRTCMode(); previewLayout(); });
  $('#rtcMode').addEventListener('change', e=> e.target.checked ? openRTC() : closeRTC());
  $('#showHours').addEventListener('change', previewLayout);
  $('#showSeconds').addEventListener('change', previewLayout);

  ['bgAngle','bgC1','bgC2','bgC3'].forEach(id=> document.getElementById(id).addEventListener('input', applyGradient));
  ['clockC1','clockC2','clockC3','textColor','colonColor'].forEach(id=> document.getElementById(id).addEventListener('input', restyleClockPanels));
  $('#waxColor').addEventListener('input', applyWax);
  window.addEventListener('resize', positionFlame);

  // Init defaults
  applyGradient(); restyleClockPanels(); applyWax();
  refreshMode(); refreshRTCMode(); previewLayout();
  setWaxHeightByProgress(1); relight(); positionFlame();
</script>
</body>
</html>

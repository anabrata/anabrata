<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SOLAR SYSTEM — WELCOME TO THE WORLD OF SOLAR SYSTEM</title>
<style>
  :root{
    --bg1:#050914; --bg2:#0a1430; --bg3:#101b3b;
    --star1:#ffffff; --star2:#a5c7ff; --star3:#ffd59e;
    --orbit:#3b4a6a; --orbitFaint:#2a3551;
    --label:#e8eefc; --accent:#22d3ee; --warn:#f43f5e;
    --sun:#ffdd55; --mercury:#b6b6b6; --venus:#cfb68a; --earth:#6fb1ff; --mars:#ff6b5a;
    --jupiter:#d9b38c; --saturn:#f1e0a8; --uranus:#8ae0e6; --neptune:#7ea8ff; --moon:#eeeeee;<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WELCOME TO THE WORLD OF SOLAR SYSTEM</title>
<style>
  :root{
    --bg1:#030711; --bg2:#0a1230; --bg3:#0f1c44;
    --orbit:#334469; --orbitFaint:#263250; --label:#e8eefc; --accent:#22d3ee;
    --sun:#ffd966; --mercury:#b9b9b9; --venus:#cdb98f; --earth:#66aaff; --mars:#ff6a5a;
    --jupiter:#d9b38c; --saturn:#f0e0a8; --uranus:#8ce3e8; --neptune:#7ea8ff; --moon:#eeeeee; --ring:#e9d9a6;
  }
  html,body{height:100%}
  *{box-sizing:border-box}
  body{
    margin:0; display:grid; grid-template-rows:auto 1fr auto;
    background: radial-gradient(140% 160% at 15% 10%, var(--bg2) 0%, var(--bg3) 45%, var(--bg1) 100%);
    color:#e5e7eb; font:400 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  header{padding:14px 12px; text-align:center}
  .banner{
    display:inline-block; font-weight:900; font-size:24px; letter-spacing:.8px; color:#e2e8f0;
    opacity:0; transform:translateY(12px);
    animation: fadeIn 2200ms ease-out forwards;
    text-shadow: 0 4px 18px #0008;
  }
  @keyframes fadeIn{to{opacity:1; transform:translateY(0)}}
  .stage{position:relative}
  canvas{width:100%; height:100%; display:block; outline:none}
  .hud{
    position:absolute; left:12px; right:12px; bottom:12px;
    display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center;
    background:#0f172acc; border:1px solid #2b3a5a; border-radius:12px; padding:8px 10px; backdrop-filter: blur(6px);
  }
  .hud label{display:flex; gap:6px; align-items:center; font-size:13px}
  .hud input[type=range]{width:180px}
  .lcd{font-variant-numeric: tabular-nums; padding:.25rem .5rem; border:1px solid #2c3a55; border-radius:8px; background:#0b1222a0}
  .badge{font-size:12px; opacity:.9; border:1px solid #334155; border-radius:6px; padding:.2rem .45rem; background:#0b1222a0}
  .legend{position:absolute; top:10px; left:10px; display:flex; gap:10px; flex-wrap:wrap; font-size:12px}
  .legend .dot{width:10px; height:10px; border-radius:50%; display:inline-block}
  .panel{
    position:absolute; left:50%; top:6%; transform:translateX(-50%); width:min(680px,95vw);
    background:#0b1222f2; border:1px solid #2b3a5a; border-radius:12px; padding:12px 14px; display:none;
    box-shadow:0 18px 40px #000a;
  }
  .panel.open{display:block}
  .panel h3{margin:0 0 6px; font-size:18px}
  .panel .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .panel .tag{display:inline-block; padding:.15rem .4rem; border-radius:6px; border:1px solid #2b3a5a; background:#0b1222; margin-right:6px; font-size:12px}
  .close{position:absolute; right:10px; top:8px; cursor:pointer}
  footer{padding:10px; text-align:center; font-weight:700}
</style>
</head>
<body>
  <header><div class="banner">WELCOME TO THE WORLD OF SOLAR SYSTEM</div></header>
  <div class="stage">
    <canvas id="c"></canvas>
    <div class="legend">
      <span><span class="dot" style="background:var(--sun)"></span>Sun</span>
      <span><span class="dot" style="background:var(--earth)"></span>Planets</span>
      <span><span class="dot" style="background:var(--moon)"></span>Moons</span>
    </div>
    <div class="hud">
      <label><input type="checkbox" id="realtime" checked> Real‑time</label>
      <label>Speed × <input type="range" id="speed" min="0.1" max="500" step="0.1" value="1"></label>
      <label><input type="checkbox" id="trails"> Trails</label>
      <label><input type="checkbox" id="labels" checked> Labels</label>
      <span class="lcd" id="clock">--:--:-- UTC</span>
      <span class="badge" id="ver">Version: v2.0.0</span>
    </div>
    <div class="panel" id="panel">
      <div class="close" id="close">✕</div>
      <h3 id="pTitle">Body</h3>
      <div class="grid"><div id="pLeft"></div><div id="pRight"></div></div>
    </div>
  </div>
  <footer>Made by ANABRATA</footer>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';

/* ---- Renderer / Scene / Camera ---- */
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.1;
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(55, 1, 0.1, 1e6);
camera.position.set(0, 220, 620);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.08;
controls.minDistance = 60;
controls.maxDistance = 5000;

/* ---- Resize ---- */
function onResize(){
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  if (canvas.width !== w || canvas.height !== h){
    renderer.setSize(w, h, false);
    camera.aspect = w/h; camera.updateProjectionMatrix();
  }
}
new ResizeObserver(onResize).observe(canvas); onResize();

/* ---- Starfield ---- */
{
  const starGeo = new THREE.BufferGeometry();
  const COUNT = 2000;
  const pos = new Float32Array(COUNT*3);
  for (let i=0;i<COUNT;i++){
    const r = 800 + Math.random()*2400;
    const t = Math.random()*Math.PI*2;
    const p = (Math.random()-0.5)*Math.PI*0.2;
    pos[i*3+0] = Math.cos(t)*r;
    pos[i*3+1] = Math.sin(p)*r*0.2;
    pos[i*3+2] = Math.sin(t)*r;
  }
  starGeo.setAttribute('position', new THREE.BufferAttribute(pos,3));
  const starMat = new THREE.PointsMaterial({size:1.6, sizeAttenuation:true, color:0xffffff, opacity:0.9, transparent:true});
  scene.add(new THREE.Points(starGeo, starMat));
}

/* ---- Sun ---- */
const sunMat = new THREE.MeshPhysicalMaterial({emissive:new THREE.Color(getCSS('--sun')), emissiveIntensity:1.4, roughness:0.6, metalness:0.0, color:0x222222});
const sun = new THREE.Mesh(new THREE.SphereGeometry(12, 48, 32), sunMat);
scene.add(sun);
const sunlight = new THREE.PointLight(0xffffff, 2.2, 0, 2);
scene.add(sunlight);

/* ---- Utilities: CSS var, scale map, math ---- */
function getCSS(n){ return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }
const TAU = Math.PI*2, RAD=Math.PI/180, DEG=180/Math.PI;
const rev = x=> x - Math.floor(x/360)*360;
function julian(now){
  const y=now.getUTCFullYear(), m=now.getUTCMonth()+1, D=now.getUTCDate();
  const hr=now.getUTCHours(), mn=now.getUTCMinutes(), sc=now.getUTCSeconds()+now.getUTCMilliseconds()/1000;
  const A = Math.floor((14-m)/12), Y = y+4800-A, M = m+12*A-3;
  const JDN = Math.floor((1461*Y)/4)+Math.floor((367*M)/12)-Math.floor((3*Math.floor((Y+100)/100))/4)+D-32075;
  return JDN + (hr-12)/24 + mn/1440 + sc/86400;
}
function dayNumber(now){ return julian(now) - 2451543.5; } // from 2000‑01‑00 00:00 UT
function keplerEllipse(Mdeg,e){
  let E = Mdeg + (180/Math.PI)*e*Math.sin(Mdeg*RAD)*(1 + e*Math.cos(Mdeg*RAD));
  for(let k=0;k<3;k++){ const Ed=E*RAD; const dE=(E-(180/Math.PI)*e*Math.sin(Ed)-Mdeg)/(1 - e*Math.cos(Ed)); E-=dE; if(Math.abs(dE)<1e-8) break; }
  const Ed=E*RAD, xv=Math.cos(Ed)-e, yv=Math.sqrt(1-e*e)*Math.sin(Ed);
  const v = Math.atan2(yv,xv)*DEG; const r = Math.sqrt(xv*xv+yv*yv); return {v,r};
}

/* ---- Schlyter elements per planet ---- */
const elements = {
  Mercury: d => ({N:48.3313+3.24587e-5*d,i:7.0047+5e-8*d,w:29.1241+1.01444e-5*d,a:0.387098,e:0.205635+5.59e-10*d,M:168.6562+4.0923344368*d}),
  Venus:   d => ({N:76.6799+2.46590e-5*d,i:3.3946+2.75e-8*d,w:54.8910+1.38374e-5*d,a:0.723330,e:0.006773-1.302e-9*d,M:48.0052+1.6021302244*d}),
  Earth:   d => ({N:0,i:0,w:282.9404+4.70935e-5*d,a:1.0,e:0.016709-1.151e-9*d,M:356.0470+0.9856002585*d}),
  Mars:    d => ({N:49.5574+2.11081e-5*d,i:1.8497-1.78e-8*d,w:286.5016+2.92961e-5*d,a:1.523688,e:0.093405+2.516e-9*d,M:18.6021+0.5240207766*d}),
  Jupiter: d => ({N:100.4542+2.76854e-5*d,i:1.3030-1.557e-7*d,w:273.8777+1.64505e-5*d,a:5.20256,e:0.048498+4.469e-9*d,M:19.8950+0.0830853001*d}),
  Saturn:  d => ({N:113.6634+2.38980e-5*d,i:2.4886-1.081e-7*d,w:339.3939+2.97661e-5*d,a:9.55475,e:0.055546-9.499e-9*d,M:316.9670+0.0334442282*d}),
  Uranus:  d => ({N:74.0005+1.3978e-5*d,i:0.7733+1.9e-8*d,w:96.6612+3.0565e-5*d,a:19.18171-1.55e-8*d,e:0.047318+7.45e-9*d,M:142.5905+0.011725806*d}),
  Neptune: d => ({N:131.7806+3.0173e-5*d,i:1.7700-2.55e-7*d,w:272.8461-6.027e-6*d,a:30.05826+3.313e-8*d,e:0.008606+2.15e-9*d,M:260.2471+0.005995147*d}),
};
function planetHelio(name, d){
  const el = elements[name](d);
  const {v,r} = keplerEllipse(rev(el.M), el.e);
  const R = r * el.a;
  const vw = (v+el.w)*RAD, N=el.N*RAD, i=el.i*RAD;
  const x= R*(Math.cos(N)*Math.cos(vw) - Math.sin(N)*Math.sin(vw)*Math.cos(i));
  const y= R*(Math.sin(N)*Math.cos(vw) + Math.cos(N)*Math.sin(vw)*Math.cos(i));
  const z= R*(Math.sin(vw)*Math.sin(i));
  return {x,y,z,R,el};
}
// Moon (geocentric) compact perturbation, then add Earth heliocentric
function moonHelio(d, earth){
  const N=125.1228 - 0.0529538083*d, i=5.1454, w=318.0634 + 0.1643573223*d, a=60.2666, e=0.054900, M=115.3654 + 13.0649929509*d;
  const km=keplerEllipse(rev(M), e); const v=km.v, r=km.r*a;
  const sunM=elements.Earth(d).M, sunw=elements.Earth(d).w;
  const Ls=rev(sunM+sunw), Lm=rev(N+w+M), D=rev(Lm-Ls), F=rev(Lm-N);
  const lon_corr=-1.274*Math.sin((M-2*D)*RAD)+0.658*Math.sin((2*D)*RAD)-0.186*Math.sin(sunM*RAD)-0.059*Math.sin((2*M-2*D)*RAD)-0.057*Math.sin((M-2*D+sunM)*RAD)+0.053*Math.sin((M+2*D)*RAD)+0.046*Math.sin((2*D-sunM)*RAD)+0.041*Math.sin((M-sunM)*RAD)-0.035*Math.sin(D*RAD)-0.031*Math.sin((M+sunM)*RAD)-0.015*Math.sin((2*F-2*D)*RAD)+0.011*Math.sin((M-4*D)*RAD);
  const lat_corr=-0.173*Math.sin((F-2*D)*RAD)-0.055*Math.sin((M-F-2*D)*RAD)-0.046*Math.sin((M+F-2*D)*RAD)+0.033*Math.sin((F+2*D)*RAD)+0.017*Math.sin((2*M+F)*RAD);
  const dist_corr=-0.58*Math.cos((M-2*D)*RAD)-0.46*Math.cos((2*D)*RAD);
  const lon = (v + w + lon_corr)*RAD, lat = (lat_corr)*RAD, rr = (r + dist_corr);
  const x = rr*Math.cos(lon)*Math.cos(lat);
  const y = rr*Math.sin(lon)*Math.cos(lat);
  const z = rr*Math.sin(lat);
  const AU_KM=149597870.7, ER=6378.14;
  return {x: earth.x + x*ER/AU_KM, y: earth.y + y*ER/AU_KM, z: earth.z + z*ER/AU_KM};
}

/* ---- Scale mapping: compress AU to scene units ---- */
function makeScale(){
  const min=0.35, max=30.0; // AU
  const span = 420;         // scene radius
  return v=>{
    const t = (Math.log10(v) - Math.log10(min)) / (Math.log10(max)-Math.log10(min));
    return 30 + t*span;
  };
}
let mapAU = makeScale();
addEventListener('resize', ()=> mapAU=makeScale(), {passive:true});

/* ---- Materials ---- */
const mats = {
  Mercury: new THREE.MeshStandardMaterial({color:getCSS('--mercury'), metalness:0.2, roughness:0.8}),
  Venus:   new THREE.MeshStandardMaterial({color:getCSS('--venus'),   metalness:0.15, roughness:0.8}),
  Earth:   new THREE.MeshStandardMaterial({color:getCSS('--earth'),   metalness:0.2, roughness:0.7}),
  Mars:    new THREE.MeshStandardMaterial({color:getCSS('--mars'),    metalness:0.2, roughness:0.8}),
  Jupiter: new THREE.MeshStandardMaterial({color:getCSS('--jupiter'), metalness:0.15, roughness:0.8}),
  Saturn:  new THREE.MeshStandardMaterial({color:getCSS('--saturn'),  metalness:0.15, roughness:0.85}),
  Uranus:  new THREE.MeshStandardMaterial({color:getCSS('--uranus'),  metalness:0.1, roughness:0.9}),
  Neptune: new THREE.MeshStandardMaterial({color:getCSS('--neptune'), metalness:0.1, roughness:0.9}),
  Moon:    new THREE.MeshStandardMaterial({color:getCSS('--moon'),    metalness:0.1, roughness:0.9}),
};
const ringMat = new THREE.MeshStandardMaterial({color:getCSS('--ring'), side:THREE.DoubleSide, transparent:true, opacity:0.65, roughness:0.8});

/* ---- Build system ---- */
const system = {};
const orbitLines = {};
const trailMap = new Map();
const sizes = { // visual radii (scene units)
  Mercury:2.5, Venus:3.5, Earth:3.8, Mars:3.2, Jupiter:8.5, Saturn:7.5, Uranus:5.0, Neptune:5.0, Moon:1.2
};
function circleOrbit(radius, faint=false){
  const geo = new THREE.RingGeometry(radius-0.05, radius+0.05, 256);
  const mat = new THREE.MeshBasicMaterial({color:faint?0x2a3551:0x334469, side:THREE.DoubleSide, transparent:true, opacity:faint?0.35:0.55});
  const m = new THREE.Mesh(geo, mat);
  m.rotation.x = Math.PI/2;
  return m;
}
function addPlanet(name, faintOrbit=false){
  const mesh = new THREE.Mesh(new THREE.SphereGeometry(sizes[name], 48, 32), mats[name]);
  mesh.userData.kind = 'planet';
  mesh.userData.name = name;
  scene.add(mesh);
  system[name] = mesh;
  const orbit = circleOrbit(mapAU(elements[name](0).a), faintOrbit);
  scene.add(orbit); orbitLines[name] = orbit;
  if(name==='Saturn'){
    const ring = new THREE.Mesh(new THREE.RingGeometry(sizes[name]*1.5, sizes[name]*2.8, 64), ringMat);
    ring.rotation.x = Math.PI/3; mesh.add(ring);
  }
}
['Mercury','Venus','Earth','Mars','Jupiter','Saturn','Uranus','Neptune'].forEach((n,i)=> addPlanet(n, n==='Saturn'));

// Earth’s Moon
const moon = new THREE.Mesh(new THREE.SphereGeometry(sizes.Moon, 32, 24), mats.Moon);
moon.userData.kind='moon'; moon.userData.name='Moon'; scene.add(moon);

// Jupiter’s main moons (circular demo)
const gal = [
  {name:'Io',a_km:421800, P_d:1.769138, color:0xffd27d, size:1.1},
  {name:'Europa',a_km:671100, P_d:3.551181, color:0xd6e6ff, size:1.1},
  {name:'Ganymede',a_km:1070400, P_d:7.154553, color:0xe6dcc9, size:1.3},
  {name:'Callisto',a_km:1882700, P_d:16.689, color:0xc9b9a1, size:1.2},
];
const AU_KM = 149597870.7;
const galMeshes = gal.map(g=>{
  const m = new THREE.Mesh(new THREE.SphereGeometry(g.size, 24, 18), new THREE.MeshStandardMaterial({color:g.color, roughness:0.9}));
  m.userData.kind='moon'; m.userData.name=g.name; scene.add(m); return m;
});

/* ---- Raycaster for clicks ---- */
const ray = new THREE.Raycaster(); const mouse = new THREE.Vector2();
const panel = document.getElementById('panel');
const pTitle = document.getElementById('pTitle'); const pLeft = document.getElementById('pLeft'); const pRight = document.getElementById('pRight');
document.getElementById('close').onclick = ()=> panel.classList.remove('open');
canvas.addEventListener('click', (e)=>{
  const rect = canvas.getBoundingClientRect();
  mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
  ray.setFromCamera(mouse, camera);
  const objs = [ ...Object.values(system), moon, ...galMeshes ];
  const hit = ray.intersectObjects(objs, false);
  if(hit){
    const name = hit.object.userData.name;
    openPanel(name);
  }
});

/* ---- Facts (subset; metric) ---- */
const facts = {
  Mercury:{ type:'Terrestrial', radius_km:2439.7, a_AU:0.387, period_d:87.97, moons:0 },
  Venus:{ type:'Terrestrial', radius_km:6051.8, a_AU:0.723, period_d:224.7, moons:0 },
  Earth:{ type:'Terrestrial', radius_km:6371.0, a_AU:1.000, period_d:365.256, moons:1 },
  Mars:{ type:'Terrestrial', radius_km:3389.5, a_AU:1.524, period_d:686.98, moons:2 },
  Jupiter:{ type:'Gas giant', radius_km:69911, a_AU:5.204, period_d:4332.59, moons:95 },
  Saturn:{ type:'Gas giant', radius_km:58232, a_AU:9.537, period_d:10759, moons:274 },
  Uranus:{ type:'Ice giant', radius_km:25362, a_AU:19.191, period_d:30687, moons:28 },
  Neptune:{ type:'Ice giant', radius_km:24622, a_AU:30.07, period_d:60190, moons:16 },
  Moon:{ type:'Natural satellite', radius_km:1737.4, a_AU:0.00257, period_d:27.32, moons:0 }
};
function openPanel(name){
  const F = facts[name] || {};
  pTitle.textContent = name;
  pLeft.innerHTML = `
    <div class="tag">Type: ${F.type||'—'}</div>
    <div class="tag">Radius: ${F.radius_km||'—'} km</div>
    <div class="tag">Mean orbit: ${F.a_AU||'—'} AU</div>
    <div class="tag">Sidereal period: ${F.period_d||'—'} d</div>
    <div class="tag">Moons: ${F.moons||'—'}</div>
  `;
  const dNow = dayNumber(new Date());
  const E = planetHelio('Earth', dNow);
  let pos, sunDist, earthDist;
  if(name==='Moon'){
    pos = moon.position.clone().multiplyScalar(1/scale);
  }else if(system[name]){
    pos = system[name].position.clone().multiplyScalar(1/scale);
  }
  if(pos){
    sunDist = Math.sqrt(pos.x*pos.x + pos.y*pos.y + pos.z*pos.z);
    earthDist = Math.sqrt((pos.x - E.x)*(pos.x - E.x) + (pos.y - E.y)*(pos.y - E.y) + (pos.z - E.z)*(pos.z - E.z));
  }
  pRight.innerHTML = `
    <div class="tag">Distance from Sun now: ${sunDist? sunDist.toFixed(3):'—'} AU</div>
    ${earthDist? `<div class="tag">Distance from Earth now: ${earthDist.toFixed(3)} AU</div>`:''}
    <div style="margin-top:6px; line-height:1.45">
      Real‑time ephemerides using classical elements and a compact lunar perturbation set render a logical, realistic picture of the system.
    </div>
  `;
  panel.classList.add('open');
}

/* ---- Time controls ---- */
const realtime = document.getElementById('realtime');
const speed = document.getElementById('speed');
const trails = document.getElementById('trails');
const labels = document.getElementById('labels');
const clockLcd = document.getElementById('clock');
document.getElementById('ver').textContent = 'Version: v2.0.0';

let simDate = new Date();
let lastT = performance.now();

/* ---- Per-frame update ---- */
let scale = 1; // scene to AU scale factor (computed on the fly)
function animate(now){
  const dt = (now - lastT)/1000; lastT = now;
  if(realtime.checked) simDate = new Date();
  else simDate = new Date(simDate.getTime() + dt*1000*parseFloat(speed.value));

  clockLcd.textContent = simDate.toISOString().slice(11,19) + ' UTC';

  // Compute day number and Earth position
  const d = dayNumber(simDate);
  const E = planetHelio('Earth', d);

  // Sun lighting position
  sun.position.set(0,0,0); sunlight.position.copy(sun.position);

  // Map AU to scene units dynamically by distance
  const mapper = v=> mapAU(v); scale = mapper(1); // approximation for unit mapping

  // Update planets
  const names = ['Mercury','Venus','Earth','Mars','Jupiter','Saturn','Uranus','Neptune'];
  names.forEach(name=>{
    const P = planetHelio(name, d);
    const r = Math.sqrt(P.x*P.x + P.y*P.y + P.z*P.z);
    const R = mapper(r)/r; // scale per current radius
    const m = system[name];
    m.position.set(P.x*R, P.z*R, P.y*R); // y<->z to keep ecliptic roughly “flat” to camera
    if(labels.checked){
      m.userData._label = m.userData._label || makeLabel(name);
      positionLabel(m.userData._label, m);
    }else if(m.userData._label){ m.userData._label.remove(); m.userData._label=null; }
    if(trails.checked) drawTrail(name, m.position);
  });

  // Moon
  const Emoon = moonHelio(d, E);
  const rM = Math.sqrt(Emoon.x*Emoon.x + Emoon.y*Emoon.y + Emoon.z*Emoon.z);
  const RM = mapper(rM)/rM;
  moon.position.set(Emoon.x*RM, Emoon.z*RM, Emoon.y*RM);
  if(labels.checked){ moon.userData._label = moon.userData._label || makeLabel('Moon'); positionLabel(moon.userData._label, moon); }
  else if(moon.userData._label){ moon.userData._label.remove(); moon.userData._label=null; }

  // Jovian moons (circular, about Jupiter)
  const J = planetHelio('Jupiter', d);
  const rJ = Math.sqrt(J.x*J.x + J.y*J.y + J.z*J.z);
  const RJ = mapper(rJ)/rJ;
  const jPos = new THREE.Vector3(J.x*RJ, J.z*RJ, J.y*RJ);
  galMeshes.forEach((gm, idx)=>{
    const g = gal[idx];
    const ang = (d/g.P_d + idx*0.25) * TAU;
    const r = (g.a_km/AU_KM) * mapper(rJ); // map relative to Jupiter’s current scale
    gm.position.set(jPos.x + Math.cos(ang)*r, jPos.y, jPos.z + Math.sin(ang)*r);
    if(labels.checked){
      gm.userData._label = gm.userData._label || makeLabel(g.name);
      positionLabel(gm.userData._label, gm);
    }else if(gm.userData._label){ gm.userData._label.remove(); gm.userData._label=null; }
  });

  controls.update();
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

/* ---- Labels as DOM elements ---- */
function makeLabel(text){
  const el = document.createElement('div');
  el.textContent = text;
  el.style.position='absolute'; el.style.color=getCSS('--label'); el.style.font='12px system-ui,Arial';
  el.style.pointerEvents='none'; el.style.textShadow='0 1px 3px #000';
  document.body.appendChild(el); return el;
}
function positionLabel(el, obj){
  const v = obj.position.clone().project(camera);
  const r = canvas.getBoundingClientRect();
  const x = (v.x*0.5+0.5)*r.width + r.left;
  const y = (-v.y*0.5+0.5)*r.height + r.top - 16;
  el.style.transform = `translate(${x}px,${y}px)`;
}

/* ---- Trails ---- */
function drawTrail(key, pos){
  if(!trailMap.has(key)) trailMap.set(key, []);
  const arr = trailMap.get(key);
  arr.push(pos.clone()); if(arr.length>180) arr.shift();
  // Draw with simple line2D overlay using projected points
  const ctx = trailCtx();
  ctx.clearRect(0,0,trailCanvas.width,trailCanvas.height);
  trailMap.forEach((points)=>{
    ctx.beginPath(); let first=true;
    points.forEach(p=>{
      const v = p.clone().project(camera);
      const r = cvsRect;
      const x = (v.x*0.5+0.5)*r.width, y = (-v.y*0.5+0.5)*r.height;
      if(first){ ctx.moveTo(x,y); first=false; } else ctx.lineTo(x,y);
    });
    ctx.strokeStyle='rgba(255,255,255,0.25)'; ctx.lineWidth=1; ctx.stroke();
  });
}
/* shared 2D overlay canvas */
let trailCanvas, trail2D, cvsRect;
function trailCtx(){
  if(!trailCanvas){
    trailCanvas = document.createElement('canvas');
    trail2D = trailCanvas.getContext('2d');
    trailCanvas.style.position='absolute'; trailCanvas.style.inset='0'; trailCanvas.style.pointerEvents='none';
    canvas.parentElement.appendChild(trailCanvas);
    new ResizeObserver(()=>{
      const r = canvas.getBoundingClientRect(); cvsRect=r;
      trailCanvas.width = r.width*devicePixelRatio; trailCanvas.height = r.height*devicePixelRatio;
      trailCanvas.style.width=r.width+'px'; trailCanvas.style.height=r.height+'px';
      trail2D.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }).observe(canvas);
  }
  return trail2D;
}
</script>
</body>
</html>

    --panel:#0b1222f2; --panelBorder:#2b3a5a; --ring:#e9d9a6;
    --banner:#e2e8f0;
    --size:min(96vmin,1000px);
  }
  html,body{height:100%}
  *{box-sizing:border-box}
  body{
    margin:0; display:grid; grid-template-rows:auto 1fr auto; gap:12px;
    background: radial-gradient(120% 140% at 20% 10%, var(--bg2) 0%, var(--bg3) 45%, var(--bg1) 100%);
    color:#e5e7eb; font:400 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  header{
    padding:12px 16px; text-align:center; position:relative; overflow:hidden;
  }
  .banner{
    display:inline-block; font-weight:800; letter-spacing:1px; font-size:20px; color:var(--banner);
    animation: fadeSlide 2200ms ease-out 1 forwards;
    text-shadow: 0 3px 16px #0008;
  }
  @keyframes fadeSlide{ from{ opacity:0; transform:translateY(12px); } to{ opacity:1; transform:translateY(0);} }
  .stage{
    display:grid; place-items:center; padding:6px 12px;
  }
  .board{
    width:var(--size); height:var(--size); position:relative;
  }
  canvas{ width:100%; height:100%; display:block; border-radius:16px; box-shadow:0 20px 60px #0008, inset 0 0 80px #0006; }
  .hud{
    position:absolute; inset:auto 12px 12px 12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center;
    background:#0f172acc; border:1px solid var(--panelBorder); border-radius:12px; padding:8px 10px; backdrop-filter: blur(6px);
  }
  .hud label{display:flex; gap:6px; align-items:center; font-size:13px}
  .hud input[type="range"]{ width:160px }
  .lcd{font-variant-numeric: tabular-nums; padding:.25rem .5rem; border:1px solid #2c3a55; border-radius:8px; background:#0b1222a0}
  .badge{font-size:12px; opacity:.9; border:1px solid #334155; border-radius:6px; padding:.2rem .45rem; background:#0b1222a0}
  footer{
    text-align:center; padding:8px 12px; color:#cbd5e1; font-weight:600;
  }
  .panel{
    position:absolute; left:50%; top:6%; transform:translateX(-50%); width:min(640px,92vw);
    background:var(--panel); border:1px solid var(--panelBorder); border-radius:12px; padding:12px 14px; display:none;
    box-shadow:0 18px 40px #000a;
  }
  .panel.open{display:block}
  .panel h3{margin:0 0 6px; font-size:18px}
  .panel .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .panel .close{position:absolute; top:8px; right:10px; cursor:pointer; color:#cbd5e1}
  .tag{display:inline-block; padding:.15rem .4rem; border-radius:6px; border:1px solid #2b3a5a; background:#0b1222; margin-right:6px; font-size:12px}
  .legend{position:absolute; top:10px; left:10px; display:flex; gap:8px; flex-wrap:wrap; font-size:12px}
  .legend span{display:inline-flex; gap:6px; align-items:center}
  .dot{width:10px; height:10px; border-radius:50%}
</style>
</head>
<body>
  <header>
    <div class="banner">WELCOME TO THE WORLD OF SOLAR SYSTEM</div>
  </header>

  <main class="stage">
    <div class="board">
      <canvas id="sky"></canvas>

      <div class="legend">
        <span><span class="dot" style="background:var(--sun)"></span>Sun</span>
        <span><span class="dot" style="background:var(--earth)"></span>Planets</span>
        <span><span class="dot" style="background:var(--moon)"></span>Moons</span>
      </div>

      <div class="hud">
        <label><input type="checkbox" id="realtime" checked> Real‑time</label>
        <label>Speed × <input type="range" id="speed" min="0.1" max="200" step="0.1" value="1"></label>
        <label><input type="checkbox" id="trails"> Trails</label>
        <label><input type="checkbox" id="labels" checked> Labels</label>
        <span class="lcd" id="clock">--:--:--</span>
        <span class="badge" id="version">Version: v1.0.0</span>
      </div>

      <div class="panel" id="panel">
        <div class="close" id="close">✕</div>
        <h3 id="pTitle">Planet</h3>
        <div class="grid">
          <div id="pLeft"></div>
          <div id="pRight"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>Made by ANABRATA</footer>

<script>
/* ===== Constants and utilities ===== */
const VERSION = 'v1.0.0';
document.getElementById('version').textContent = 'Version: ' + VERSION;

// Canvas setup with DPR scaling + ResizeObserver for crisp rendering
const canvas = document.getElementById('sky');
const ctx = canvas.getContext('2d', {alpha:true});
let DPR = 1;
function fitCanvas(){
  const r = canvas.getBoundingClientRect();
  DPR = Math.max(1, Math.min(window.devicePixelRatio||1, 3));
  canvas.width = Math.round(r.width * DPR);
  canvas.height = Math.round(r.height * DPR);
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(DPR, DPR);
}
new ResizeObserver(fitCanvas).observe(canvas); fitCanvas();

// Time control
const realtime = document.getElementById('realtime');
const speed = document.getElementById('speed');
const trails = document.getElementById('trails');
const labels = document.getElementById('labels');
const clockLcd = document.getElementById('clock');

// Colors
const color = {
  Sun: getCss('--sun'), Mercury:getCss('--mercury'), Venus:getCss('--venus'),
  Earth:getCss('--earth'), Mars:getCss('--mars'), Jupiter:getCss('--jupiter'),
  Saturn:getCss('--saturn'), Uranus:getCss('--uranus'), Neptune:getCss('--neptune'),
  Moon:getCss('--moon')
};
function getCss(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

// Star field (cached)
let stars = [];
function buildStars(){
  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;
  const N = 600;
  stars = [];
  for(let i=0;i<N;i++){
    stars.push({
      x: Math.random()*w, y: Math.random()*h,
      r: Math.random()*1.4+0.2,
      c: Math.random()<0.6? getCss('--star1') : (Math.random()<0.5? getCss('--star2'):getCss('--star3')),
      a: Math.random()*0.6+0.2,
    });
  }
}
buildStars();
addEventListener('resize', buildStars, {passive:true});

/* ===== Astronomical helpers (Schlyter) =====
   Units: angles in radians internally; days for time; AU for distances.
   Source: Paul Schlyter’s planetary position tutorial and element tables. */

// Degree/radian helpers
const PI = Math.PI, TAU = Math.PI*2, RAD = PI/180, DEG = 180/PI;
const sind = x=>Math.sin(x*RAD), cosd = x=>Math.cos(x*RAD), atand = x=>Math.atan(x)*DEG, atan2d = (y,x)=>Math.atan2(y,x)*DEG;
const rev = x => x - Math.floor(x/360)*360;

// Julian date (UTC)
function julian(now){
  // Gregorian algorithm (works for all modern dates, JD at noon base)
  // Derivation: Wikipedia "Julian day"
  const y = now.getUTCFullYear();
  const m = now.getUTCMonth()+1;
  const D = now.getUTCDate();
  const hr = now.getUTCHours();
  const mn = now.getUTCMinutes();
  const sc = now.getUTCSeconds() + now.getUTCMilliseconds()/1000;
  const A = Math.floor((14 - m)/12);
  const Y = y + 4800 - A;
  const M = m + 12*A - 3;
  const JDN = Math.floor((1461*Y)/4) + Math.floor((367*M)/12) - Math.floor((3*Math.floor((Y+100)/100))/4) + D - 32075;
  const JD = JDN + (hr - 12)/24 + mn/1440 + sc/86400;
  return JD;
}

// Day number d from 2000-01-00 00:00 UT
function dayNumber(now){
  const JD = julian(now);
  return JD - 2451543.5; // Schlyter’s epoch offset
}

// Ecliptic obliquity (degrees) if needed; here we stay in ecliptic plane top-down.
// function obliquity(d){ return 23.4393 - 3.563E-7 * d; }

// Solve Kepler for elliptical orbit (angles in degrees)
function keplerEllipse(Mdeg, e){
  // Use first-order + one iteration for robustness
  let E = Mdeg + (180/Math.PI)*e * Math.sin(Mdeg*RAD) * (1 + e*Math.cos(Mdeg*RAD));
  for(let k=0;k<2;k++){
    const Ed = E*RAD;
    const dE = (E - (180/Math.PI)*e*Math.sin(Ed) - Mdeg) / (1 - e*Math.cos(Ed));
    E -= dE;
    if(Math.abs(dE)<1e-6) break;
  }
  const Ed = E*RAD;
  const xv = Math.cos(Ed) - e;
  const yv = Math.sqrt(1 - e*e) * Math.sin(Ed);
  const v = atan2d(yv, xv);
  const r = Math.sqrt(xv*xv + yv*yv); // in units of a
  return {v, r};
}

// Orbital elements for planets (Schlyter), each as functions of day number d
const elements = {
  Mercury: d => ({
    N: 48.3313 + 3.24587e-5*d,
    i: 7.0047 + 5.0e-8*d,
    w: 29.1241 + 1.01444e-5*d,
    a: 0.387098,
    e: 0.205635 + 5.59e-10*d,
    M: 168.6562 + 4.0923344368*d
  }),
  Venus: d => ({
    N: 76.6799 + 2.46590e-5*d,
    i: 3.3946 + 2.75e-8*d,
    w: 54.8910 + 1.38374e-5*d,
    a: 0.723330,
    e: 0.006773 - 1.302e-9*d,
    M: 48.0052 + 1.6021302244*d
  }),
  Earth: d => ({ // Using the Sun/Earth barycentric ellipse for Earth’s heliocentric position
    N: 0, i: 0,
    w: 282.9404 + 4.70935e-5*d,
    a: 1.000000,
    e: 0.016709 - 1.151e-9*d,
    M: 356.0470 + 0.9856002585*d
  }),
  Mars: d => ({
    N: 49.5574 + 2.11081e-5*d,
    i: 1.8497 - 1.78e-8*d,
    w: 286.5016 + 2.92961e-5*d,
    a: 1.523688,
    e: 0.093405 + 2.516e-9*d,
    M: 18.6021 + 0.5240207766*d
  }),
  Jupiter: d => ({
    N: 100.4542 + 2.76854e-5*d,
    i: 1.3030 - 1.557e-7*d,
    w: 273.8777 + 1.64505e-5*d,
    a: 5.20256,
    e: 0.048498 + 4.469e-9*d,
    M: 19.8950 + 0.0830853001*d
  }),
  Saturn: d => ({
    N: 113.6634 + 2.38980e-5*d,
    i: 2.4886 - 1.081e-7*d,
    w: 339.3939 + 2.97661e-5*d,
    a: 9.55475,
    e: 0.055546 - 9.499e-9*d,
    M: 316.9670 + 0.0334442282*d
  }),
  Uranus: d => ({
    N: 74.0005 + 1.3978e-5*d,
    i: 0.7733 + 1.9e-8*d,
    w: 96.6612 + 3.0565e-5*d,
    a: 19.18171 - 1.55e-8*d,
    e: 0.047318 + 7.45e-9*d,
    M: 142.5905 + 0.011725806*d
  }),
  Neptune: d => ({
    N: 131.7806 + 3.0173e-5*d,
    i: 1.7700 - 2.55e-7*d,
    w: 272.8461 - 6.027e-6*d,
    a: 30.05826 + 3.313e-8*d,
    e: 0.008606 + 2.15e-9*d,
    M: 260.2471 + 0.005995147*d
  }),
};

// Convert orbital elements -> heliocentric ecliptic rectangular coords (AU)
function planetHelio(name, d){
  const el = elements[name](d);
  const {v, r} = keplerEllipse(rev(el.M), el.e); // r in units of a
  const R = r * el.a; // AU
  const vw = (v + el.w)*RAD, N = el.N*RAD, i = el.i*RAD;
  const xh = R*(Math.cos(N)*Math.cos(vw) - Math.sin(N)*Math.sin(vw)*Math.cos(i));
  const yh = R*(Math.sin(N)*Math.cos(vw) + Math.cos(N)*Math.sin(vw)*Math.cos(i));
  const zh = R*(Math.sin(vw)*Math.sin(i));
  return {x:xh,y:yh,z:zh,R,el};
}

// Moon (geocentric) from Schlyter simplified lunar model with main perturbations
function earthMoon(d){
  // Elements for Moon
  const N = 125.1228 - 0.0529538083*d;
  const i = 5.1454;
  const w = 318.0634 + 0.1643573223*d;
  const a = 60.2666; // Earth radii
  const e = 0.054900;
  const M = 115.3654 + 13.0649929509*d;
  // Solve ellipse
  const km = keplerEllipse(rev(M), e);
  const v = km.v, r = km.r*a; // r in Earth radii
  // Perturbations need Sun Moon angles
  // Sun mean long
  const sunM = elements.Earth(d).M;
  const sunw = elements.Earth(d).w;
  const Ls = rev(sunM + sunw);
  const Lm = rev(N + w + M);
  const D = rev(Lm - Ls);
  const F = rev(Lm - N);
  // Longitude perturbations (deg)
  const lon_corr =
      -1.274*Math.sin((M - 2*D)*RAD)
    + 0.658*Math.sin((2*D)*RAD)
    - 0.186*Math.sin(sunM*RAD)
    - 0.059*Math.sin((2*M - 2*D)*RAD)
    - 0.057*Math.sin((M - 2*D + sunM)*RAD)
    + 0.053*Math.sin((M + 2*D)*RAD)
    + 0.046*Math.sin((2*D - sunM)*RAD)
    + 0.041*Math.sin((M - sunM)*RAD)
    - 0.035*Math.sin(D*RAD)
    - 0.031*Math.sin((M + sunM)*RAD)
    - 0.015*Math.sin((2*F - 2*D)*RAD)
    + 0.011*Math.sin((M - 4*D)*RAD);
  const lat_corr =
      -0.173*Math.sin((F - 2*D)*RAD)
      -0.055*Math.sin((M - F - 2*D)*RAD)
      -0.046*Math.sin((M + F - 2*D)*RAD)
      +0.033*Math.sin((F + 2*D)*RAD)
      +0.017*Math.sin((2*M + F)*RAD);
  const dist_corr =
      -0.58*Math.cos((M - 2*D)*RAD)
      -0.46*Math.cos((2*D)*RAD);
  const lon = rev(v + w + lon_corr);
  const lat = (lat_corr);
  const rr = r + dist_corr; // Earth radii
  const Nrad = N*RAD, irad = i*RAD, lrad = lon*RAD, brad = lat*RAD;
  const xeclip = rr*Math.cos(lrad)*Math.cos(brad);
  const yeclip = rr*Math.sin(lrad)*Math.cos(brad);
  const zeclip = rr*Math.sin(brad);
  // Convert to AU: Earth equatorial radius ~ 6378.14 km; 1 AU = 149597870.7 km
  const AU = 149597870.7; const ER = 6378.14;
  return {x:xeclip*ER/AU, y:yeclip*ER/AU, z:zeclip*ER/AU, rr};
}

// Simple moon models for Jupiter (Galileans): circular, in ecliptic plane, with real periods and semimajor axes
const Galilean = [
  {name:'Io',       a_km:421800,  P_d:1.769138, col:'#ffd27d'},
  {name:'Europa',   a_km:671100,  P_d:3.551181, col:'#d6e6ff'},
  {name:'Ganymede', a_km:1070400, P_d:7.154553, col:'#e6dcc9'},
  {name:'Callisto', a_km:1882700, P_d:16.689,   col:'#c9b9a1'},
];
// AU conversion
const AU_KM = 149597870.7;
function jovianMoons(d, jx, jy){
  // phase reference: M=0 at J2000
  return Galilean.map((m,i)=>{
    const ang = TAU*((d)/m.P_d + i*0.25); // staggered phase
    const r = (m.a_km/AU_KM);
    return {name:m.name, x: jx + r*Math.cos(ang), y: jy + r*Math.sin(ang), col:m.col};
  });
}

/* ===== Bodies and facts (NASA fact sheets) ===== */
const facts = {
  Mercury:{ type:'Terrestrial', radius_km:2439.7, a_AU:0.387, period_d:87.97, moons:0, ref:'NASA Fact Sheet' },
  Venus:{ type:'Terrestrial', radius_km:6051.8, a_AU:0.723, period_d:224.7, moons:0, ref:'NASA Fact Sheet' },
  Earth:{ type:'Terrestrial', radius_km:6371.0, a_AU:1.000, period_d:365.256, moons:1, ref:'NASA Fact Sheet' },
  Mars:{ type:'Terrestrial', radius_km:3389.5, a_AU:1.524, period_d:686.98, moons:2, ref:'NASA Fact Sheet' },
  Jupiter:{ type:'Gas giant', radius_km:69911, a_AU:5.204, period_d:4332.59, moons:95, ref:'NASA Fact Sheet' },
  Saturn:{ type:'Gas giant', radius_km:58232, a_AU:9.537, period_d:10759, moons:274, ref:'NASA Fact Sheet' },
  Uranus:{ type:'Ice giant', radius_km:25362, a_AU:19.191, period_d:30687, moons:28, ref:'NASA Fact Sheet' },
  Neptune:{ type:'Ice giant', radius_km:24622, a_AU:30.07, period_d:60190, moons:16, ref:'NASA Fact Sheet' },
  Moon:{ type:'Natural satellite', radius_km:1737.4, a_AU:0.00257, period_d:27.32, moons:0, ref:'NASA Fact Sheet' }
};

// Drawing scale
function scaleAU(){ // logarithmic scaling for visibility
  const min = 0.4, max = 30;
  const w = canvas.getBoundingClientRect().width;
  const m = Math.min(w, canvas.getBoundingClientRect().height)*0.45;
  return v => {
    const t = (Math.log10(v) - Math.log10(min)) / (Math.log10(max) - Math.log10(min));
    return 40 + t*m;
  };
}
let mapAU = scaleAU();
addEventListener('resize', ()=> mapAU = scaleAU());

// For clicking
let hitlist = [];

// UI panel
const panel = document.getElementById('panel');
const pTitle = document.getElementById('pTitle');
const pLeft = document.getElementById('pLeft');
const pRight = document.getElementById('pRight');
document.getElementById('close').onclick = ()=> panel.classList.remove('open');
canvas.addEventListener('click',(ev)=>{
  const rect = canvas.getBoundingClientRect();
  const x = (ev.clientX - rect.left);
  const y = (ev.clientY - rect.top);
  // find nearest hit within radius
  let best = null, bd = 9999;
  for(const h of hitlist){
    const d2 = (h.sx-x)*(h.sx-x)+(h.sy-y)*(h.sy-y);
    if(d2 < h.r*h.r && d2 < bd){ best = h; bd = d2; }
  }
  if(best){
    showPanel(best);
  }
});

function showPanel(h){
  const f = facts[h.name] || {type:'—',radius_km:'—',a_AU:'—',period_d:'—',moons:'—'};
  pTitle.textContent = h.name;
  pLeft.innerHTML = `
    <div class="tag">Type: ${f.type}</div>
    <div class="tag">Radius: ${f.radius_km} km</div>
    <div class="tag">Mean orbit: ${f.a_AU} AU</div>
    <div class="tag">Sidereal period: ${f.period_d} d</div>
    <div class="tag">Moons: ${f.moons}</div>
  `;
  pRight.innerHTML = `
    <div class="tag">Distance from Sun now: ${h.sunDistAU.toFixed(3)} AU</div>
    ${h.earthDistAU? `<div class="tag">Distance from Earth now: ${h.earthDistAU.toFixed(3)} AU</div>`:''}
    <div style="margin-top:6px; line-height:1.4">Beautiful, realistic rendering with live ephemerides; values update as time changes.</div>
  `;
  panel.classList.add('open');
}

// Orbit trails
const trailMap = new Map();

// Animation state
let t0 = performance.now();
let simDate = new Date();
function step(now){
  const dt = (now - t0)/1000; t0 = now;
  const speedMul = parseFloat(speed.value);
  if(realtime.checked){
    simDate = new Date(); // wall clock
  }else{
    simDate = new Date(simDate.getTime() + dt*1000*speedMul);
  }
  draw(simDate);
  requestAnimationFrame(step);
}
requestAnimationFrame(step);

// Main draw
function draw(now){
  const rect = canvas.getBoundingClientRect();
  const W = rect.width, H = rect.height;
  // background
  ctx.clearRect(0,0,W,H);
  // starfield
  for(const s of stars){ ctx.globalAlpha=s.a; ctx.fillStyle=s.c; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,TAU); ctx.fill(); }
  ctx.globalAlpha=1;

  // center
  const cx = W/2, cy = H/2;

  // Time display
  clockLcd.textContent = now.toLocaleTimeString('en-GB',{hour12:false})+' UTC';

  // Compute day number
  const d = dayNumber(now);

  // Sun at center
  drawBody(cx, cy, 10, color.Sun, 'Sun');

  // Planets
  // First compute Earth for distances and Moon positioning
  const earth = planetHelio('Earth', d);
  // Moon geocentric, then add to Earth's heliocentric position
  const moonGeo = earthMoon(d);
  const moon = { x: earth.x + moonGeo.x, y: earth.y + moonGeo.y };

  hitlist = []; // clear
  const names = ['Mercury','Venus','Earth','Mars','Jupiter','Saturn','Uranus','Neptune'];
  const positions = {};

  // Orbits and planets
  for(const name of names){
    const p = planetHelio(name, d);
    positions[name] = p;
    const rAU = Math.hypot(p.x, p.y);
    const sx = cx + (p.x/rAU) * mapAU(rAU);
    const sy = cy + (p.y/rAU) * mapAU(rAU);

    // orbit path
    drawOrbit(cx, cy, mapAU(p.el.a), name==='Saturn'? true:false);

    // planet disk size
    const Rpix = planetRadiusPx(name);
    drawBody(sx, sy, Rpix, color[name], name, labels.checked);

    // maintain hit info
    const earthDistAU = Math.hypot(p.x - earth.x, p.y - earth.y);
    hitlist.push({name, sx, sy, r:Math.max(12,Rpix+6), sunDistAU:rAU, earthDistAU});

    if(trails.checked){
      const key = name;
      if(!trailMap.has(key)) trailMap.set(key, []);
      const arr = trailMap.get(key);
      arr.push([sx, sy]); if(arr.length>220) arr.shift();
      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.beginPath();
      for(let i=0;i<arr.length;i++){ const a=arr[i]; if(i===0) ctx.moveTo(a,a[33]); else ctx.lineTo(a,a[33]); }
      ctx.stroke();
    }else{
      trailMap.delete(name);
    }

    // Saturn ring visual
    if(name==='Saturn'){
      ctx.save(); ctx.strokeStyle = getCss('--ring'); ctx.globalAlpha=0.6;
      ctx.beginPath(); ctx.ellipse(sx, sy, Rpix*2.4, Rpix*1.2, 0, 0, TAU); ctx.stroke();
      ctx.restore();
    }
  }

  // Earth label & Moon
  const eR = Math.hypot(earth.x, earth.y);
  const eSX = cx + (earth.x/eR)*mapAU(eR);
  const eSY = cy + (earth.y/eR)*mapAU(eR);
  const mR = Math.hypot(moon.x, moon.y);
  const mSX = cx + (moon.x/mR)*mapAU(mR);
  const mSY = cy + (moon.y/mR)*mapAU(mR);
  drawBody(mSX, mSY, 4, color.Moon, 'Moon', labels.checked);
  hitlist.push({name:'Moon', sx:mSX, sy:mSY, r:12, sunDistAU: mR, earthDistAU: Math.hypot(moon.x-earth.x, moon.y-earth.y)});

  // Jupiter moons
  const j = positions['Jupiter'];
  const moons = jovianMoons(d, j.x, j.y);
  for(const mm of moons){
    const r = Math.hypot(mm.x, mm.y);
    const sx = cx + (mm.x/r)*mapAU(r);
    const sy = cy + (mm.y/r)*mapAU(r);
    drawBody(sx, sy, 3, mm.col, mm.name, false);
    hitlist.push({name: mm.name, sx, sy, r:10, sunDistAU:r, earthDistAU: Math.hypot(mm.x-earth.x, mm.y-earth.y)});
  }
}

// Drawing helpers
function drawOrbit(cx, cy, radius, faint=false){
  ctx.save();
  ctx.strokeStyle = faint? getCss('--orbitFaint'):getCss('--orbit');
  ctx.globalAlpha = faint? 0.35:0.55;
  ctx.beginPath();
  ctx.arc(cx, cy, radius, 0, TAU);
  ctx.stroke();
  ctx.restore();
}
function drawBody(x, y, r, fill, name, showLabel=false){
  const g = ctx.createRadialGradient(x-r*0.5, y-r*0.5, r*0.2, x, y, r);
  g.addColorStop(0, '#ffffff');
  g.addColorStop(0.12, fill);
  g.addColorStop(1, '#000000');
  ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x,y,r,0,TAU); ctx.fill();
  if(showLabel){
    ctx.fillStyle = getCss('--label'); ctx.font='12px system-ui, Arial'; ctx.textAlign='center';
    ctx.fillText(name, x, y - r - 6);
  }
}
// Planet render size (for visibility)
function planetRadiusPx(name){
  switch(name){
    case 'Mercury': return 4;
    case 'Venus': return 6.5;
    case 'Earth': return 7;
    case 'Mars': return 5.5;
    case 'Jupiter': return 12;
    case 'Saturn': return 10;
    case 'Uranus': return 8;
    case 'Neptune': return 8;
    default: return 6;
  }
}
</script>
</body>
</html>
